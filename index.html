<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#090c11" />
  <title>Dart-Set-and-Leg-Counter</title>

  <style>
    :root{
      --radius:18px;
      --tap: 56px;

      --fs-title: clamp(18px, 4.6vw, 26px);
      --fs-body:  clamp(15px, 4vw, 18px);
      --fs-meta:  clamp(12px, 3.3vw, 14px);

      --fs-name:  clamp(18px, 4.8vw, 22px);
      --fs-col:   clamp(12px, 3.2vw, 13px);
      --fs-num:   clamp(20px, 5.4vw, 26px);

      /* Dart-Optik Akzente */
      --pA: #d61f26;
      --pB: #14a44d;

      --boardWhite: #f7f8fb;
      --boardBlack: #0b0f14;
    }

    html[data-theme="dark"]{
      --bg0:#05070a;
      --bg1:#090c11;
      --panelA: rgba(9,11,15,.93);
      --panelB: rgba(13,16,21,.93);
      --text:#f7f8fb;
      --muted: rgba(247,248,251,.72);
      --line: rgba(247,248,251,.14);
      --shadow: 0 16px 36px rgba(0,0,0,.55);
      --inputBg: rgba(0,0,0,.40);
      --btnBg: rgba(255,255,255,.05);
      --tapBg: rgba(255,255,255,.03);
      --tapBgActive: rgba(255,255,255,.08);
      --dartOpacity: .22;
      --themeColor: #090c11;
      --sbHeaderBg: rgba(255,255,255,.10); /* vollfl√§chig, ohne Verlauf */
    }

    html[data-theme="light"]{
      --bg0:#eef1f4;
      --bg1:#ffffff;
      --panelA: rgba(255,255,255,.96);
      --panelB: rgba(248,249,251,.96);
      --text:#0b0f14;
      --muted: rgba(11,15,20,.68);
      --line: rgba(11,15,20,.14);
      --shadow: 0 14px 28px rgba(0,0,0,.12);
      --inputBg: rgba(255,255,255,.92);
      --btnBg: rgba(11,15,20,.05);
      --tapBg: rgba(11,15,20,.03);
      --tapBgActive: rgba(11,15,20,.07);
      --dartOpacity: .12;
      --themeColor: #ffffff;
      --sbHeaderBg: rgba(11,15,20,.08); /* vollfl√§chig, ohne Verlauf */
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow-x:hidden; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 760px at 12% -10%, color-mix(in srgb, var(--pA) 18%, transparent), transparent 60%),
        radial-gradient(1080px 740px at 92% 0%, color-mix(in srgb, var(--pB) 16%, transparent), transparent 60%),
        radial-gradient(900px 520px at 50% 110%, color-mix(in srgb, var(--boardBlack) 14%, transparent), transparent 62%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      padding:
        max(14px, env(safe-area-inset-top))
        max(14px, env(safe-area-inset-right))
        max(14px, env(safe-area-inset-bottom))
        max(14px, env(safe-area-inset-left));
    }

    .wrap{ max-width: 980px; margin: 0 auto; position:relative; overflow-x: clip; }

    /* Dart-Pfeil Hintergrund */
    .wrap::before{
      content:"";
      position:absolute;
      left: 50%;
      top: 54%;
      width: min(980px, 140vw);
      height: min(980px, 140vw);
      transform: translate(-50%,-50%) rotate(-18deg);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 900 900'%3E%3Cdefs%3E%3CradialGradient id='v' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff' stop-opacity='.20'/%3E%3Cstop offset='55%25' stop-color='%23000000' stop-opacity='.12'/%3E%3Cstop offset='100%25' stop-color='%23000000' stop-opacity='0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cg opacity='.92'%3E%3Cpath d='M160 530 L540 150 L610 220 L230 600 Z' fill='%23ffffff' fill-opacity='.10'/%3E%3Cpath d='M540 150 L690 90 L740 140 L610 220 Z' fill='%23d61f26' fill-opacity='.26'/%3E%3Cpath d='M230 600 L610 220 L680 290 L300 670 Z' fill='%2314a44d' fill-opacity='.24'/%3E%3Cpath d='M300 670 L680 290 L810 420 L430 800 Z' fill='%23ffffff' fill-opacity='.08'/%3E%3C/g%3E%3Ccircle cx='450' cy='450' r='430' fill='url(%23v)'/%3E%3C/svg%3E");
      background-size: cover;
      background-repeat: no-repeat;
      filter: blur(12px);
      opacity: var(--dartOpacity);
      pointer-events:none;
      z-index:0;
    }

    .navbar{
      position: sticky;
      top: max(0px, env(safe-area-inset-top));
      z-index: 10;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--panelA) 90%, transparent), color-mix(in srgb, var(--panelB) 90%, transparent));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 10px 12px;
      margin-bottom: 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .brandIcon{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid color-mix(in srgb, var(--text) 16%, transparent);
      background:
        radial-gradient(circle at 30% 30%, color-mix(in srgb, var(--pA) 22%, transparent), transparent 55%),
        radial-gradient(circle at 70% 70%, color-mix(in srgb, var(--pB) 18%, transparent), transparent 55%),
        color-mix(in srgb, var(--btnBg) 92%, transparent);
      flex: 0 0 auto;
    }
    .brandTitle{
      font-size: var(--fs-title);
      font-weight: 1100;
      letter-spacing: .2px;
      line-height: 1.12;
      white-space: normal;
      overflow: visible;
      word-break: break-word;
    }
    .topActions{ display:flex; gap:10px; align-items:center; flex: 0 0 auto; }

    .card{
      position:relative;
      z-index:1;
      background: linear-gradient(180deg, var(--panelA), var(--panelB));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      margin-bottom: 14px;
    }

    label{ display:block; font-size: var(--fs-meta); color: var(--muted); margin: 0 0 6px; }

    input, select{
      width:100%;
      font-size: var(--fs-body);
      padding: 12px;
      min-height: var(--tap);
      border-radius: 14px;
      border: 1px solid color-mix(in srgb, var(--text) 18%, transparent);
      background: var(--inputBg);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: color-mix(in srgb, var(--text) 45%, transparent); }

    .meta{ color: var(--muted); font-size: var(--fs-meta); margin-top: 10px; line-height:1.35; }

    button{
      appearance:none;
      border: 1px solid color-mix(in srgb, var(--text) 16%, transparent);
      background: var(--btnBg);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      min-height: var(--tap);
      font-size: var(--fs-body);
      font-weight: 900;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button.primary{
      border-color: color-mix(in srgb, var(--pA) 58%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--pA) 92%, white 0%), color-mix(in srgb, var(--pA) 70%, black 22%));
      color: #fff;
    }
    button.ghost{ box-shadow:none; background: var(--btnBg); }
    button.small{
      min-height: 40px;
      padding: 8px 10px;
      font-size: var(--fs-meta);
      border-radius: 999px;
      box-shadow:none;
    }
    .themeBtn{
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: var(--fs-meta);
      font-weight: 900;
      box-shadow:none;
      white-space: nowrap;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .hidden{ display:none!important; }

    /* ---- Setup: Spielerliste ---- */
    .playersList{ display:grid; gap: 12px; }

    .playerRow{
      border: 1px solid color-mix(in srgb, var(--text) 12%, transparent);
      background: color-mix(in srgb, var(--btnBg) 92%, transparent);
      border-radius: 14px;
      padding: 10px;
      display:grid;
      gap: 10px;
    }

    .playerRowTop{
      display:grid;
      grid-template-columns: 48px 1fr 44px;
      gap: 10px;
      align-items:center;
    }

    .colorPickBtn{
      width: 48px;
      height: 48px;
      min-height: 48px;
      padding: 0;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:none;
      background: color-mix(in srgb, var(--btnBg) 92%, transparent);
      border: 1px solid color-mix(in srgb, var(--text) 18%, transparent);
    }
    .colorPickBtn::after{
      content:"";
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid color-mix(in srgb, var(--text) 65%, transparent);
      background: var(--dot, #fff);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }

    .trashBtn{
      min-height: 44px;
      padding: 8px 10px;
      border-radius: 12px;
      box-shadow:none;
      font-size: 18px;
    }

    .palette{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid color-mix(in srgb, var(--text) 12%, transparent);
      background: color-mix(in srgb, var(--btnBg) 92%, transparent);
    }

    .swatch{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 2px solid color-mix(in srgb, var(--text) 28%, transparent);
      background: var(--c);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      min-height: 34px;
      box-shadow:none;
      position: relative;
    }
    .swatch.selected{
      outline: 3px solid color-mix(in srgb, var(--text) 42%, transparent);
      outline-offset: 2px;
    }
    .swatch.disabled{
      opacity: .26;
      cursor: not-allowed;
      filter: grayscale(65%);
    }
    .swatch .check{
      font-size: 16px;
      line-height: 1;
      opacity: 0;
      transform: translateY(-1px);
      color: color-mix(in srgb, var(--text) 92%, transparent);
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    .swatch.selected .check{ opacity: 1; }

    /* ---- Spiel: Scoreboard ---- */
    .scoreboard{ padding: 0; overflow:hidden; }

    .sb-header{
      display:grid;
      grid-template-columns: 94px 1fr 74px 74px; /* mehr Abstand, kein √úberlappen */
      align-items:center;
      padding: 10px 14px;
      border-bottom: 1px solid color-mix(in srgb, var(--text) 12%, transparent);
      background: var(--sbHeaderBg); /* vollfl√§chig, ohne Verlauf */
      column-gap: 10px;
    }
    .sb-header .col, .sb-header .left{
      font-size: var(--fs-col);
      color: color-mix(in srgb, var(--muted) 92%, transparent);
      font-weight: 1000;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .sb-header .col{ text-align:center; }
    .sb-header .left{ text-align:left; }

    .sb-row{
      display:grid;
      grid-template-columns: 94px 1fr 74px 74px;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid color-mix(in srgb, var(--text) 10%, transparent);
      background: var(--tapBg);
      column-gap: 10px;
    }
    .sb-row:last-child{ border-bottom:none; }

    /* kr√§ftigere Spielerfl√§chen */
    .sb-row.playerA{
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--pA) 52%, transparent),
        color-mix(in srgb, var(--tapBg) 64%, transparent)
      );
    }
    .sb-row.playerB{
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--pB) 52%, transparent),
        color-mix(in srgb, var(--tapBg) 64%, transparent)
      );
    }

    /* iOS Tap sicher */
    .tap{ touch-action: manipulation; }

    .serveCell{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      font-weight: 1100;
      opacity: .95;
      color: color-mix(in srgb, var(--text) 92%, transparent);
    }
    .serveCell.none{ opacity: 0; }

    .name{
      display:flex;
      align-items:center;
      min-height: 44px;
      font-size: var(--fs-name);
      font-weight: 1100;
      letter-spacing: .2px;
      min-width: 0;
    }
    .name span{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .num{
      text-align:center;
      font-size: var(--fs-num);
      font-weight: 1100;
      letter-spacing: .3px;
    }

    .badgeLine{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin: 12px 0 0;
      color: var(--muted);
      font-size: var(--fs-meta);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--text) 14%, transparent);
      background: color-mix(in srgb, var(--btnBg) 90%, transparent);
      font-weight: 900;
    }
    .chipDot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .chipDot.a{ background: var(--pA); }
    .chipDot.b{ background: var(--pB); }

    .hint{
      margin-top: 10px;
      font-size: var(--fs-meta);
      color: color-mix(in srgb, var(--text) 62%, transparent);
    }

    .log{
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      background: color-mix(in srgb, var(--btnBg) 90%, transparent);
      border: 1px solid color-mix(in srgb, var(--text) 12%, transparent);
      border-radius: 14px;
      padding: 12px;
      max-height: 170px;
      overflow: auto;
      margin-top: 10px;
    }

    /* ---- Fortsetzen Card ---- */
    .resumeRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- SETUP -->
  <div id="screenSetup">
    <div class="navbar">
      <div class="brand">
        <div class="brandIcon" aria-hidden="true">üéØ</div>
        <div class="brandTitle">Dart-Set-and-Leg-Counter</div>
      </div>
      <div class="topActions">
        <button class="themeBtn ghost" id="themeToggle" type="button" aria-label="Theme wechseln">
          <span id="themeIcon">üåô</span>
          <span id="themeLabel">Dark</span>
        </button>
      </div>
    </div>

    <div class="card hidden" id="resumeCard">
      <div style="font-weight:1100; margin-bottom:6px;">Es gibt ein gespeichertes Match.</div>
      <div class="meta" id="resumeMeta" style="margin-top:0;">‚Äî</div>
      <div class="controls" style="margin-top:12px;">
        <button class="primary" id="resumeBtn" type="button">Fortsetzen</button>
        <button class="ghost" id="discardBtn" type="button">Neues Match anlegen</button>
      </div>
    </div>

    <div class="card">
      <label>Spieler</label>
      <div class="playersList" id="playersList"></div>

      <div class="controls" style="margin-top:12px;">
        <button class="ghost" id="addPlayer" type="button">+ Spieler hinzuf√ºgen</button>
        <span class="spacer"></span>
        <span class="meta" style="margin-top:0;">Farben sind nur einmal w√§hlbar.</span>
      </div>
      <div class="meta">Einstellungen werden gespeichert. (Namen bleiben als Vorschl√§ge erhalten.)</div>
    </div>

    <div class="card">
      <div class="controls" style="gap:12px;">
        <div style="flex:1; min-width: 240px;">
          <label for="pickA">Teilnehmer links</label>
          <select id="pickA"></select>
        </div>
        <div style="flex:1; min-width: 240px;">
          <label for="pickB">Teilnehmer rechts</label>
          <select id="pickB"></select>
        </div>
      </div>

      <div class="controls" style="gap:12px; margin-top:12px;">
        <div style="flex:1; min-width: 240px;">
          <label for="bestOfSets">Best of (Sets)</label>
          <select id="bestOfSets">
            <option value="5">Best of 5</option>
            <option value="7">Best of 7</option>
            <option value="15">Best of 15</option>
          </select>
        </div>
        <div style="flex:1; min-width: 240px;">
          <label for="legsToWinSet">Legs pro Set</label>
          <select id="legsToWinSet">
            <option value="3">First to 3 Legs</option>
            <option value="5">First to 5 Legs</option>
          </select>
        </div>
      </div>

      <div class="controls" style="gap:12px; margin-top:12px;">
        <div style="flex:1; min-width: 240px;">
          <label for="firstServer">Anwurf in Set 1 / Leg 1</label>
          <select id="firstServer">
            <option value="A">Links</option>
            <option value="B">Rechts</option>
          </select>
        </div>
        <div style="flex:1; min-width: 240px;">
          <label>&nbsp;</label>
          <div class="meta" id="formatHint" style="margin-top:0;"></div>
        </div>
      </div>

      <div class="controls" style="margin-top:14px;">
        <button class="primary" id="startBtn" type="button">Spiel starten</button>
        <button class="ghost" id="quickHelpBtn" type="button">Kurzhilfe</button>
      </div>

      <div class="meta" id="helpText" style="display:none;">
        Im Spiel: Tippen Sie auf die Spielerzeile = Leg +1. Langer Druck auf Spielerzeile = Undo.<br>
        Der ‚ñ∂-Pfeil zeigt den aktuellen Anwurf f√ºr das n√§chste Leg.
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div id="screenGame" class="hidden">
    <div class="navbar">
      <div class="brand">
        <div class="brandIcon" aria-hidden="true">üéØ</div>
        <div class="brandTitle">Dart-Set-and-Leg-Counter</div>
      </div>
      <div class="topActions">
        <button class="themeBtn ghost" id="themeToggle2" type="button" aria-label="Theme wechseln">
          <span id="themeIcon2">üåô</span>
          <span id="themeLabel2">Dark</span>
        </button>
      </div>
    </div>

    <div class="card scoreboard">
      <div class="sb-header">
        <div class="col">ANWURF</div>
        <div class="left">NAME</div>
        <div class="col">SETS</div>
        <div class="col">LEGS</div>
      </div>

      <div class="sb-row tap playerA" id="rowA" role="button" aria-label="Leg gewonnen links">
        <div class="serveCell" id="serveA">‚ñ∂</div>
        <div class="name"><span id="titleA">Spieler</span></div>
        <div class="num" id="setsA">0</div>
        <div class="num" id="legsA">0</div>
      </div>

      <div class="sb-row tap playerB" id="rowB" role="button" aria-label="Leg gewonnen rechts">
        <div class="serveCell" id="serveB">‚ñ∂</div>
        <div class="name"><span id="titleB">Spieler</span></div>
        <div class="num" id="setsB">0</div>
        <div class="num" id="legsB">0</div>
      </div>

      <div style="padding:12px 14px;">
        <div class="badgeLine">
          <span class="pill" id="matchPill"></span>
          <span class="pill" id="legsPill"></span>
          <span class="pill"><span class="chipDot a"></span><span id="pillA">Spieler links</span></span>
          <span class="pill"><span class="chipDot b"></span><span id="pillB">Spieler rechts</span></span>
        </div>

        <div class="controls" style="margin-top:12px;">
          <button class="ghost" id="undo" type="button">Undo</button>
          <button class="ghost" id="newMatch" type="button">Neues Match</button>
          <span class="spacer"></span>
          <button class="ghost small" id="toggleLog" type="button" aria-expanded="false">Verlauf anzeigen</button>
        </div>

        <div class="log hidden" id="log"></div>
        <div class="hint">Anwurf (‚ñ∂) wechselt automatisch pro Leg und pro Set.</div>
      </div>
    </div>
  </div>

</div>

<script>
  const SETTINGS_KEY = "dart_counter_settings_v10";
  const MATCH_KEY    = "dart_counter_match_v10";
  const THEME_KEY    = "dart_counter_theme_v2";

  const COLOR_OPTIONS = [
    { key: "red",    name: "Rot",     hex: "#d61f26" },
    { key: "green",  name: "Gr√ºn",    hex: "#14a44d" },
    { key: "black",  name: "Schwarz", hex: "#0b0f14" },
    { key: "white",  name: "Wei√ü",    hex: "#f7f8fb" },
    { key: "blue",   name: "Blau",    hex: "#2f6bff" },
    { key: "yellow", name: "Gelb",    hex: "#f2c230" },
    { key: "pink",   name: "Pink",    hex: "#ff3ea5" },
    { key: "orange", name: "Orange",  hex: "#f97316" },
    { key: "gray",   name: "Grau",    hex: "#9ca3af" }
  ];

  const el = (id) => document.getElementById(id);
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const state = {
    players: [
      { id: "p1", name: "", color: "#d61f26" },
      { id: "p2", name: "", color: "#14a44d" }
    ],
    pick: { A: "p1", B: "p2" },

    bestOfSets: 5,
    firstToSets: 3,
    legsToWinSet: 3,
    firstServer: "A",

    match: {
      inProgress: false,
      matchOver: false,
      active: { A: "p1", B: "p2" },
      sets: { A: 0, B: 0 },
      legs: { A: 0, B: 0 },
      legsTotal: { A: 0, B: 0 },
      history: []
    }
  };

  const other = (p) => (p === "A" ? "B" : "A");
  const computeFirstTo = (bestOf) => Math.floor(bestOf / 2) + 1;

  function haptic(ms = 14) { try { if (navigator.vibrate) navigator.vibrate(ms); } catch(_){} }

  /* ---------- Theme ---------- */
  function setTheme(theme){
    const t = (theme === "light") ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", t);
    const meta = document.querySelector('meta[name="theme-color"]');
    meta && meta.setAttribute("content",
      getComputedStyle(document.documentElement).getPropertyValue("--themeColor").trim() || (t==="light" ? "#ffffff" : "#090c11")
    );
    const label = (t === "light") ? "Light" : "Dark";
    const icon  = (t === "light") ? "‚òÄÔ∏è" : "üåô";
    el("themeLabel").textContent  = label;
    el("themeLabel2").textContent = label;
    el("themeIcon").textContent   = icon;
    el("themeIcon2").textContent  = icon;
    try { localStorage.setItem(THEME_KEY, t); } catch(_) {}
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
    haptic(8);
  }
  function loadTheme(){
    try { setTheme(localStorage.getItem(THEME_KEY) || "dark"); }
    catch(_) { setTheme("dark"); }
  }

  /* ---------- Persist ---------- */
  function saveSettings(){
    try{
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({
        players: state.players,
        pick: state.pick,
        bestOfSets: state.bestOfSets,
        legsToWinSet: state.legsToWinSet,
        firstServer: state.firstServer
      }));
    }catch(_){}
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return;
      const s = JSON.parse(raw);

      if(Array.isArray(s.players) && s.players.length >= 2){
        // Wichtig: Namen bleiben erlaubt, aber NIE automatisch ins Input "vorausgef√ºllt", au√üer es ist wirklich gespeichert.
        state.players = s.players.map((p, i)=>({
          id: (typeof p.id === "string" && p.id) ? p.id : ("p"+(i+1)),
          name: (typeof p.name === "string") ? p.name : "",
          color: (typeof p.color === "string" && p.color) ? p.color : COLOR_OPTIONS[i % COLOR_OPTIONS.length].hex
        }));
      }

      if(s.pick && typeof s.pick.A === "string" && typeof s.pick.B === "string"){
        state.pick.A = s.pick.A;
        state.pick.B = s.pick.B;
      }

      state.bestOfSets   = [5,7,15].includes(+s.bestOfSets) ? +s.bestOfSets : state.bestOfSets;
      state.legsToWinSet = [3,5].includes(+s.legsToWinSet) ? +s.legsToWinSet : state.legsToWinSet;
      state.firstServer  = (s.firstServer === "B") ? "B" : "A";

      state.firstToSets = computeFirstTo(state.bestOfSets);
      dedupeInvalidPicks();
      enforceUniqueColorsAll();
    }catch(_){}
  }

  function saveMatch(){
    try{
      localStorage.setItem(MATCH_KEY, JSON.stringify({
        inProgress: state.match.inProgress,
        matchOver: state.match.matchOver,
        active: state.match.active,
        sets: state.match.sets,
        legs: state.match.legs,
        legsTotal: state.match.legsTotal,
        history: state.match.history,
        bestOfSets: state.bestOfSets,
        firstToSets: state.firstToSets,
        legsToWinSet: state.legsToWinSet,
        firstServer: state.firstServer
      }));
    }catch(_){}
  }

  function loadMatch(){
    try{
      const raw = localStorage.getItem(MATCH_KEY);
      if(!raw) return false;
      const m = JSON.parse(raw);
      if(!m || !m.inProgress) return false;

      state.match.inProgress = !!m.inProgress;
      state.match.matchOver  = !!m.matchOver;
      state.match.active     = m.active || state.match.active;
      state.match.sets       = m.sets || state.match.sets;
      state.match.legs       = m.legs || state.match.legs;
      state.match.legsTotal  = m.legsTotal || state.match.legsTotal;
      state.match.history    = Array.isArray(m.history) ? m.history : [];

      // Format aus Match √ºbernehmen (damit Fortsetzen exakt passt)
      if([5,7,15].includes(+m.bestOfSets)) state.bestOfSets = +m.bestOfSets;
      state.firstToSets = computeFirstTo(state.bestOfSets);
      if([3,5].includes(+m.legsToWinSet)) state.legsToWinSet = +m.legsToWinSet;
      state.firstServer = (m.firstServer === "B") ? "B" : "A";

      return (state.match.inProgress && !state.match.matchOver);
    }catch(_){
      return false;
    }
  }

  function clearMatchStorage(){
    try{ localStorage.removeItem(MATCH_KEY); }catch(_){}
  }

  /* ---------- Setup helpers ---------- */
  function playerLabel(p, idx){
    const name = (p.name || "").trim();
    return name ? name : `Spieler ${idx+1}`;
  }

  function dedupeInvalidPicks(){
    const ids = new Set(state.players.map(p=>p.id));
    if(!ids.has(state.pick.A)) state.pick.A = state.players[0].id;
    if(!ids.has(state.pick.B)) state.pick.B = state.players[1].id;
    if(state.pick.A === state.pick.B){
      const alt = state.players.find(p=>p.id !== state.pick.A);
      state.pick.B = alt ? alt.id : state.pick.B;
    }
  }

  function usedColors(exceptPlayerId=null){
    const used = new Set();
    for(const p of state.players){
      if(exceptPlayerId && p.id === exceptPlayerId) continue;
      used.add((p.color||"").toLowerCase());
    }
    return used;
  }

  function firstFreeColor(usedSet){
    const found = COLOR_OPTIONS.find(c => !usedSet.has(c.hex.toLowerCase()));
    return found ? found.hex : COLOR_OPTIONS[0].hex;
  }

  function enforceUniqueColorsAll(){
    const seen = new Set();
    for(const p of state.players){
      const c = (p.color||"").toLowerCase();
      if(!c || seen.has(c)){
        const used = usedColors(p.id);
        p.color = firstFreeColor(used);
      }
      seen.add(p.color.toLowerCase());
    }
  }

  /* ---------- Render setup (players) ---------- */
  let openPaletteFor = null;

  function renderPlayers(){
    const list = el("playersList");
    list.innerHTML = "";

    state.players.forEach((p, idx)=>{
      const row = document.createElement("div");
      row.className = "playerRow";

      const top = document.createElement("div");
      top.className = "playerRowTop";

      const colorBtn = document.createElement("button");
      colorBtn.type = "button";
      colorBtn.className = "colorPickBtn";
      colorBtn.style.setProperty("--dot", p.color);
      colorBtn.setAttribute("aria-label", `Farbe f√ºr Spieler ${idx+1} w√§hlen`);
      colorBtn.addEventListener("click", ()=>{
        openPaletteFor = (openPaletteFor === p.id) ? null : p.id;
        renderPlayers();
        haptic(8);
      });

      const input = document.createElement("input");
      input.placeholder = `Spieler ${idx+1}`;
      // WICHTIG: Kein Default-Text im value f√ºr neu hinzugef√ºgte Spieler
      input.value = (typeof p.name === "string") ? p.name : "";
      input.addEventListener("input", ()=>{
        p.name = input.value; // kann leer sein
        saveSettings();
        renderPickSelects();
        renderSetupHint();
      });

      const trash = document.createElement("button");
      trash.type = "button";
      trash.className = "trashBtn ghost";
      trash.textContent = "üóëÔ∏è";
      trash.disabled = (state.players.length <= 2); // min. 2 Spieler behalten
      trash.title = "Spieler entfernen";
      trash.addEventListener("click", ()=>{
        if(state.players.length <= 2) return;
        // Wenn entfernte Person gerade ausgew√§hlt ist, Picks reparieren
        state.players = state.players.filter(x=>x.id !== p.id);
        openPaletteFor = null;
        dedupeInvalidPicks();
        enforceUniqueColorsAll();
        saveSettings();
        renderPlayers();
        renderPickSelects();
        renderSetupHint();
        haptic(12);
      });

      top.appendChild(colorBtn);
      top.appendChild(input);
      top.appendChild(trash);

      row.appendChild(top);

      if(openPaletteFor === p.id){
        const pal = document.createElement("div");
        pal.className = "palette";
        const used = usedColors(p.id);

        COLOR_OPTIONS.forEach(c=>{
          const sw = document.createElement("button");
          sw.type = "button";
          sw.className = "swatch";
          sw.style.setProperty("--c", c.hex);

          const check = document.createElement("span");
          check.className = "check";
          check.textContent = "‚úì";
          sw.appendChild(check);

          const hex = c.hex.toLowerCase();
          sw.classList.toggle("selected", hex === (p.color||"").toLowerCase());
          sw.classList.toggle("disabled", used.has(hex));

          sw.addEventListener("click", ()=>{
            if(used.has(hex)) return; // Farben nur einmal w√§hlbar
            p.color = c.hex;
            enforceUniqueColorsAll();
            saveSettings();
            applyActiveColorsToCSS(); // falls aktiver Pick ge√§ndert
            renderPlayers();
            renderPickSelects();
            haptic(10);
          });

          pal.appendChild(sw);
        });

        row.appendChild(pal);
      }

      list.appendChild(row);
    });

    // Klick au√üerhalb schlie√üt Palette
    document.addEventListener("click", onDocClickClosePalettes, { once: true });
  }

  function onDocClickClosePalettes(e){
    const inPalette = e.target.closest(".palette") || e.target.closest(".colorPickBtn") || e.target.closest(".swatch");
    if(!inPalette){
      openPaletteFor = null;
      renderPlayers();
    }
  }

  function renderPickSelects(){
    const selA = el("pickA");
    const selB = el("pickB");

    const build = (sel, current) => {
      sel.innerHTML = "";
      state.players.forEach((p, idx)=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = playerLabel(p, idx);
        if(p.id === current) opt.selected = true;
        sel.appendChild(opt);
      });
    };

    build(selA, state.pick.A);
    build(selB, state.pick.B);

    // Falls gleich, reparieren
    if(state.pick.A === state.pick.B){
      const alt = state.players.find(p=>p.id !== state.pick.A);
      if(alt) state.pick.B = alt.id;
      build(selB, state.pick.B);
    }

    selA.onchange = ()=>{
      state.pick.A = selA.value;
      if(state.pick.A === state.pick.B){
        const alt = state.players.find(p=>p.id !== state.pick.A);
        if(alt) state.pick.B = alt.id;
      }
      saveSettings();
      renderPickSelects();
      applyActiveColorsToCSS();
      renderSetupHint();
    };

    selB.onchange = ()=>{
      state.pick.B = selB.value;
      if(state.pick.B === state.pick.A){
        const alt = state.players.find(p=>p.id !== state.pick.B);
        if(alt) state.pick.A = alt.id;
      }
      saveSettings();
      renderPickSelects();
      applyActiveColorsToCSS();
      renderSetupHint();
    };
  }

  function renderSetupHint(){
    state.firstToSets = computeFirstTo(state.bestOfSets);
    const bestOf = +el("bestOfSets").value;
    const firstTo = computeFirstTo(bestOf);
    const legsToWin = +el("legsToWinSet").value;
    const starter = el("firstServer").value === "B" ? "Rechts" : "Links";
    el("formatHint").textContent =
      `Match: First to ${firstTo} Sets ¬∑ Set: First to ${legsToWin} Legs ¬∑ Anwurf Start: ${starter}`;
  }

  function show(screen){
    el("screenSetup").classList.toggle("hidden", screen !== "setup");
    el("screenGame").classList.toggle("hidden", screen !== "game");
    openPaletteFor = null;
    renderPlayers();
  }

  /* ---------- Match logic (2 Spieler) ---------- */
  function getPlayerById(id){
    return state.players.find(p=>p.id === id) || state.players[0];
  }

  function applyActiveColorsToCSS(){
    const pA = getPlayerById(state.pick.A);
    const pB = getPlayerById(state.pick.B);
    document.documentElement.style.setProperty("--pA", pA.color || "#d61f26");
    document.documentElement.style.setProperty("--pB", pB.color || "#14a44d");
  }

  function snapshot(){
    state.match.history.push(JSON.parse(JSON.stringify({
      inProgress: state.match.inProgress,
      matchOver: state.match.matchOver,
      active: state.match.active,
      sets: state.match.sets,
      legs: state.match.legs,
      legsTotal: state.match.legsTotal,
      bestOfSets: state.bestOfSets,
      firstToSets: state.firstToSets,
      legsToWinSet: state.legsToWinSet,
      firstServer: state.firstServer
    })));
    if(state.match.history.length > 80) state.match.history.shift();
  }

  function logLine(t){
    el("log").textContent = t + "\n" + el("log").textContent;
  }

  function currentSetNumber(){ return state.match.sets.A + state.match.sets.B + 1; }
  function currentLegNumberWithinSet(){ return state.match.legs.A + state.match.legs.B + 1; }

  function computeThrower(){
    const setNo = currentSetNumber();
    const setStarter = (setNo % 2 === 1) ? state.firstServer : other(state.firstServer);
    const legNo = currentLegNumberWithinSet();
    return (legNo % 2 === 1) ? setStarter : other(setStarter);
  }

  function renderGame(){
    const pLeft  = getPlayerById(state.match.active.A);
    const pRight = getPlayerById(state.match.active.B);

    // Farben f√ºrs Match
    document.documentElement.style.setProperty("--pA", pLeft.color  || "#d61f26");
    document.documentElement.style.setProperty("--pB", pRight.color || "#14a44d");

    el("titleA").textContent = (pLeft.name||"").trim()  || "Spieler";
    el("titleB").textContent = (pRight.name||"").trim() || "Spieler";
    el("pillA").textContent  = (pLeft.name||"").trim()  || "Spieler links";
    el("pillB").textContent  = (pRight.name||"").trim() || "Spieler rechts";

    el("setsA").textContent = state.match.sets.A;
    el("setsB").textContent = state.match.sets.B;
    el("legsA").textContent = state.match.legs.A;
    el("legsB").textContent = state.match.legs.B;

    el("matchPill").textContent = `Best of ${state.bestOfSets} (First to ${state.firstToSets})`;
    el("legsPill").textContent  = `Legs/Set: First to ${state.legsToWinSet}`;

    const thrower = computeThrower();
    el("serveA").classList.toggle("none", thrower !== "A");
    el("serveB").classList.toggle("none", thrower !== "B");

    saveMatch();
  }

  function finishMatchIfNeeded(player){
    if(state.match.sets[player] >= state.firstToSets){
      state.match.matchOver = true;
      state.match.inProgress = false;
      saveMatch();
      alert(`Match beendet! Ergebnis: ${state.match.sets.A}-${state.match.sets.B} Sets`);
      return true;
    }
    return false;
  }

  function awardSet(player){
    state.match.sets[player] += 1;
    state.match.legs.A = 0;
    state.match.legs.B = 0;
    logLine(`Set an ${player === "A" ? el("titleA").textContent : el("titleB").textContent} ‚Äî Sets: ${state.match.sets.A}-${state.match.sets.B}`);
    finishMatchIfNeeded(player);
  }

  function addLeg(player){
    if(state.match.matchOver) return;
    snapshot();
    state.match.legs[player] += 1;
    state.match.legsTotal[player] += 1;
    haptic(12);
    logLine(`Leg an ${player === "A" ? el("titleA").textContent : el("titleB").textContent} ‚Äî Legs: ${state.match.legs.A}-${state.match.legs.B}`);

    if(state.match.legs[player] >= state.legsToWinSet){
      awardSet(player);
      if(state.match.matchOver){ renderGame(); return; }
    }
    renderGame();
  }

  function undo(){
    if(state.match.matchOver) return;
    const prev = state.match.history.pop();
    if(!prev) return;

    state.match.inProgress = prev.inProgress;
    state.match.matchOver  = prev.matchOver;
    state.match.active     = prev.active;
    state.match.sets       = prev.sets;
    state.match.legs       = prev.legs;
    state.match.legsTotal  = prev.legsTotal;

    state.bestOfSets   = prev.bestOfSets;
    state.firstToSets  = prev.firstToSets;
    state.legsToWinSet = prev.legsToWinSet;
    state.firstServer  = prev.firstServer;

    el("bestOfSets").value   = String(state.bestOfSets);
    el("legsToWinSet").value = String(state.legsToWinSet);
    el("firstServer").value  = state.firstServer;

    haptic(10);
    logLine("Undo.");
    renderGame();
  }

  function toggleLog(){
    el("log").classList.toggle("hidden");
    const vis = !el("log").classList.contains("hidden");
    el("toggleLog").textContent = vis ? "Verlauf ausblenden" : "Verlauf anzeigen";
    el("toggleLog").setAttribute("aria-expanded", String(vis));
    haptic(8);
  }

  /* iOS-sicher: Tap + Longpress */
  function attachTapAndLongPress(targetEl, onTap, onLongPress){
    const LONG = 450;
    let timer = null;
    let didLong = false;

    const clear = () => {
      if(timer) clearTimeout(timer);
      timer = null;
    };

    targetEl.addEventListener("pointerdown", () => {
      didLong = false;
      clear();
      timer = setTimeout(() => {
        didLong = true;
        onLongPress();
        haptic(10);
      }, LONG);
    }, { passive: true });

    targetEl.addEventListener("pointerup", () => {
      if(!didLong) onTap();
      clear();
    });

    targetEl.addEventListener("pointercancel", clear);
    targetEl.addEventListener("pointerleave", clear);
    targetEl.addEventListener("contextmenu", (e)=> e.preventDefault());
  }

  /* ---------- New match behavior (wichtig f√ºr Ihre Anforderung) ---------- */
  function clearSelectedNamesInSetup(){
    // ‚ÄûNeues Match anlegen‚Äú soll neue Namen erlauben, ohne ‚Äûalten Namen l√∂schen‚Äú.
    // Daher leeren wir die beiden aktuell ausgew√§hlten Teilnehmer im Setup.
    const a = state.players.find(p=>p.id === state.pick.A);
    const b = state.players.find(p=>p.id === state.pick.B);
    if(a) a.name = "";
    if(b) b.name = "";
    saveSettings();
  }

  function startMatch(){
    // Setup √ºbernehmen
    state.bestOfSets   = +el("bestOfSets").value;
    state.firstToSets  = computeFirstTo(state.bestOfSets);
    state.legsToWinSet = +el("legsToWinSet").value;
    state.firstServer  = (el("firstServer").value === "B") ? "B" : "A";

    dedupeInvalidPicks();

    // Match init
    state.match.inProgress = true;
    state.match.matchOver = false;
    state.match.active = { A: state.pick.A, B: state.pick.B };
    state.match.sets = { A: 0, B: 0 };
    state.match.legs = { A: 0, B: 0 };
    state.match.legsTotal = { A: 0, B: 0 };
    state.match.history = [];
    el("log").textContent = "";

    const pLeft  = getPlayerById(state.pick.A);
    const pRight = getPlayerById(state.pick.B);

    logLine(`Start: ${playerLabel(pLeft, 0)} vs ${playerLabel(pRight, 1)} ‚Äî Best of ${state.bestOfSets} ‚Äî Legs/Set: ${state.legsToWinSet} ‚Äî Anwurf: ${state.firstServer === "A" ? "Links" : "Rechts"}`);
    el("log").classList.add("hidden");
    el("toggleLog").textContent = "Verlauf anzeigen";
    el("toggleLog").setAttribute("aria-expanded","false");

    saveSettings();
    saveMatch();
    renderGame();
    haptic(12);
    show("game");
  }

  function showResumeUIIfNeeded(){
    const has = loadMatch();
    if(has){
      // Text bauen
      const pLeft  = getPlayerById(state.match.active.A);
      const pRight = getPlayerById(state.match.active.B);
      el("resumeMeta").textContent =
        `${(pLeft.name||"").trim()||"Spieler links"} vs ${(pRight.name||"").trim()||"Spieler rechts"} ¬∑ Sets ${state.match.sets.A}-${state.match.sets.B} ¬∑ Legs ${state.match.legs.A}-${state.match.legs.B}`;
      el("resumeCard").classList.remove("hidden");
    }else{
      el("resumeCard").classList.add("hidden");
    }
  }

  /* ---------- Wiring ---------- */
  document.addEventListener("DOMContentLoaded", ()=>{
    loadTheme();
    loadSettings();

    // Setup selects initial
    el("bestOfSets").value   = String(state.bestOfSets);
    el("legsToWinSet").value = String(state.legsToWinSet);
    el("firstServer").value  = state.firstServer;

    // Setup render
    enforceUniqueColorsAll();
    renderPlayers();
    renderPickSelects();
    applyActiveColorsToCSS();
    renderSetupHint();

    // Resume?
    showResumeUIIfNeeded();

    el("themeToggle").addEventListener("click", toggleTheme);
    el("themeToggle2").addEventListener("click", toggleTheme);

    el("addPlayer").addEventListener("click", ()=>{
      if(state.players.length >= COLOR_OPTIONS.length){
        alert("Maximale Spieleranzahl erreicht (entspricht Anzahl verf√ºgbarer Farben).");
        return;
      }
      const used = usedColors(null);
      const newColor = firstFreeColor(used);
      state.players.push({ id: uid(), name: "", color: newColor }); // name leer -> kein ‚Äûerst l√∂schen‚Äú
      enforceUniqueColorsAll();
      saveSettings();
      renderPlayers();
      renderPickSelects();
      haptic(12);
    });

    ["bestOfSets","legsToWinSet","firstServer"].forEach(id=>{
      el(id).addEventListener("change", ()=>{
        if(id === "bestOfSets"){
          state.bestOfSets = +el("bestOfSets").value;
          state.firstToSets = computeFirstTo(state.bestOfSets);
        }
        if(id === "legsToWinSet") state.legsToWinSet = +el("legsToWinSet").value;
        if(id === "firstServer") state.firstServer = el("firstServer").value === "B" ? "B" : "A";
        saveSettings();
        renderSetupHint();
      });
    });

    el("quickHelpBtn").addEventListener("click", ()=>{
      const t = el("helpText");
      t.style.display = (t.style.display === "none") ? "block" : "none";
      haptic(8);
    });

    el("startBtn").addEventListener("click", startMatch);

    // iOS-sicheres Scoring
    attachTapAndLongPress(el("rowA"), () => addLeg("A"), undo);
    attachTapAndLongPress(el("rowB"), () => addLeg("B"), undo);

    el("undo").addEventListener("click", undo);
    el("toggleLog").addEventListener("click", toggleLog);

    el("newMatch").addEventListener("click", ()=>{
      haptic(10);
      if(confirm("Neues Match anlegen? (Match wird verworfen und Setup ge√∂ffnet)")){
        // Match verwerfen
        state.match.inProgress = false;
        state.match.matchOver = false;
        state.match.history = [];
        clearMatchStorage();

        // Wichtig: damit Sie NICHT die alten Namen im neuen Match haben:
        clearSelectedNamesInSetup();

        // Setup neu rendern
        renderPlayers();
        renderPickSelects();
        applyActiveColorsToCSS();
        renderSetupHint();
        show("setup");
      }
    });

    // Resume-Buttons
    el("resumeBtn").addEventListener("click", ()=>{
      if(!loadMatch()){
        showResumeUIIfNeeded();
        return;
      }
      haptic(12);
      show("game");
      renderGame();
    });

    el("discardBtn").addEventListener("click", ()=>{
      haptic(10);
      if(confirm("Gespeichertes Match verwerfen und neues Match anlegen?")){
        clearMatchStorage();
        state.match.inProgress = false;
        state.match.matchOver = false;
        state.match.history = [];
        clearSelectedNamesInSetup();
        showResumeUIIfNeeded();
        renderPlayers();
        renderPickSelects();
      }
    });
  });
</script>
</body>
</html>