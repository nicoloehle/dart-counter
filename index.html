<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b8161c" />
  <title>Dart Set &amp; Leg Counter</title>

  <style>
    :root{
      --radius:18px;
      --tap: 56px;

      --fs-title: clamp(18px, 4.6vw, 26px);
      --fs-body:  clamp(15px, 4vw, 18px);
      --fs-meta:  clamp(12px, 3.3vw, 14px);

      --fs-name:  clamp(18px, 4.8vw, 22px);
      --fs-col:   clamp(12px, 3.2vw, 13px);
      --fs-num:   clamp(20px, 5.4vw, 26px);

      /* Dart-Basisfarben */
      --dartRed:   #b8161c;
      --dartRedHi: #ff3a41;
      --dartGreen: #0f7a2b;
      --dartGreenHi:#1ad35f;
      --dartBlack: #0b0f14;
      --dartWhite: #f7f8fb;

      /* UI */
      --bg: var(--dartGreen);
      --text: var(--dartWhite);
      --muted: rgba(247,248,251,.80);

      --panelA: rgba(10,13,18,.94);
      --panelB: rgba(16,20,27,.94);
      --panelEdge: rgba(255,255,255,.16);
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      --inputBg: rgba(0,0,0,.32);

      --btnEdge: rgba(255,255,255,.18);
      --tapBg: rgba(255,255,255,.04);

      /* Scoreboard Header */
      --sbHeaderText: rgba(11,15,20,.92);

      /* Player colors (default) */
      --pA: #d61f26;
      --pB: #14a44d;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow-x:hidden; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      padding:
        max(14px, env(safe-area-inset-top))
        max(14px, env(safe-area-inset-right))
        max(14px, env(safe-area-inset-bottom))
        max(14px, env(safe-area-inset-left));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      min-height: 100%;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow-x: clip;
    }

    .wrap::before{
      content:"";
      position:absolute;
      inset:-140px;
      pointer-events:none;
      opacity:.22;
      background-image:
        radial-gradient(circle at 18% 22%, rgba(255,255,255,.18), transparent 42%),
        radial-gradient(circle at 82% 30%, rgba(0,0,0,.26), transparent 46%),
        radial-gradient(circle at 50% 85%, rgba(255,255,255,.10), transparent 52%),
        repeating-conic-gradient(from 18deg,
          rgba(255,255,255,.10) 0 10deg,
          transparent 10deg 18deg),
        repeating-linear-gradient(45deg, rgba(0,0,0,.18) 0 8px, transparent 8px 22px);
      mix-blend-mode: overlay;
      filter: blur(1.2px);
      z-index:0;
    }

    .main{ position:relative; z-index:1; flex:1; }

    .navbar{
      position: sticky;
      top: max(0px, env(safe-area-inset-top));
      z-index: 10;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.20);
      background: linear-gradient(180deg, var(--dartRedHi), var(--dartRed));
      box-shadow: 0 16px 34px rgba(0,0,0,.28);
      padding: 10px 12px;
      margin-bottom: 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }

    .logoImg{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.26);
      background: rgba(0,0,0,.18);
      flex: 0 0 auto;
      object-fit: cover;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }

    .brandTitle{
      font-size: var(--fs-title);
      font-weight: 1200;
      letter-spacing: .2px;
      line-height: 1.12;
      color: #fff;
      text-shadow: 0 10px 20px rgba(0,0,0,.22);
      white-space: normal;
      word-break: break-word;
    }

    .topActions{ display:flex; gap:10px; align-items:center; flex: 0 0 auto; }

    .card{
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid var(--panelEdge);
      background:
        radial-gradient(900px 260px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 300px at 0% 100%, rgba(0,0,0,.28), transparent 58%),
        linear-gradient(180deg, var(--panelA), var(--panelB));
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-90px;
      pointer-events:none;
      opacity:.22;
      background: repeating-conic-gradient(from 0deg,
        rgba(255,255,255,.08) 0 12deg,
        transparent 12deg 18deg);
      mix-blend-mode: overlay;
      filter: blur(.2px);
    }

    label{ display:block; font-size: var(--fs-meta); color: var(--muted); margin: 0 0 6px; }

    input, select{
      width:100%;
      font-size: var(--fs-body);
      padding: 12px;
      min-height: var(--tap);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: var(--inputBg);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: rgba(255,255,255,.55); }

    .meta{ color: var(--muted); font-size: var(--fs-meta); margin-top: 10px; line-height:1.35; }

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(140px 85px at 30% 25%, rgba(255,255,255,.14), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      min-height: var(--tap);
      font-size: var(--fs-body);
      font-weight: 950;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px) scale(.99); }

    button.primary{
      border-color: rgba(255,255,255,.24);
      background:
        radial-gradient(160px 95px at 30% 25%, rgba(255,255,255,.18), transparent 64%),
        linear-gradient(180deg, var(--dartRedHi), var(--dartRed));
      color:#fff;
      box-shadow: 0 16px 30px rgba(0,0,0,.22);
    }

    button.ghost{
      box-shadow:none;
      background:
        radial-gradient(140px 85px at 30% 25%, rgba(255,255,255,.10), transparent 62%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
    }

    button.small{
      min-height: 40px;
      padding: 8px 10px;
      font-size: var(--fs-meta);
      border-radius: 999px;
      box-shadow:none;
    }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }
    .hidden{ display:none!important; }

    /* ---- Setup: Spielerliste ---- */
    .playersList{ display:grid; gap: 12px; }

    .playerRow{
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(260px 140px at 25% 15%, rgba(255,255,255,.08), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      border-radius: 14px;
      padding: 10px;
      display:grid;
      gap: 10px;
      position:relative;
      overflow:hidden;
    }
    .playerRow::before{
      content:"";
      position:absolute; inset:-70px;
      pointer-events:none;
      opacity:.18;
      background: repeating-conic-gradient(from 0deg,
        rgba(255,255,255,.10) 0 14deg,
        transparent 14deg 18deg);
      mix-blend-mode: overlay;
    }

    .playerRowTop{
      display:grid;
      grid-template-columns: 48px 1fr 44px;
      gap: 10px;
      align-items:center;
      position:relative;
      z-index:1;
    }

    .colorPickBtn{
      width: 48px;
      height: 48px;
      min-height: 48px;
      padding: 0;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:none;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.22);
    }
    .colorPickBtn::after{
      content:"";
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.78);
      background: var(--dot, #fff);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }

    .trashBtn{
      min-height: 44px;
      padding: 8px 10px;
      border-radius: 12px;
      box-shadow:none;
      font-size: 18px;
    }

    .palette{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      position:relative;
      z-index:1;
    }

    .swatch{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.24);
      background: var(--c);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      min-height: 34px;
      box-shadow:none;
      position: relative;
      overflow:hidden;
    }
    .swatch.selected{
      outline: 3px solid rgba(255,255,255,.42);
      outline-offset: 2px;
    }
    .swatch.taken{
      opacity: .95;
      cursor: not-allowed;
      filter: none;
    }
    .swatch.taken::after{
      content:"";
      position:absolute;
      inset:-6px;
      background:
        linear-gradient(135deg,
          transparent 47%,
          rgba(255,255,255,.92) 48%,
          rgba(255,255,255,.92) 52%,
          transparent 53%);
      opacity: .9;
      pointer-events:none;
    }
    .swatch .check{
      font-size: 16px;
      line-height: 1;
      opacity: 0;
      transform: translateY(-1px);
      color: rgba(255,255,255,.96);
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    .swatch.selected .check{ opacity: 1; }

    /* ---- Spiel: Scoreboard ---- */
    .scoreboard{ padding: 0; overflow:hidden; }

    .sb-header{
      display:grid;
      grid-template-columns: 86px 1fr 70px 70px;
      align-items:center;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(0,0,0,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
      column-gap: 10px;
      position:relative;
    }
    .sb-header::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height: 3px;
      background:
        linear-gradient(90deg,
          var(--dartRed) 0 50%,
          var(--dartGreenHi) 50% 100%);
      opacity:.95;
    }
    .sb-header .col, .sb-header .left{
      font-size: var(--fs-col);
      color: var(--sbHeaderText);
      font-weight: 1200;
      letter-spacing: .28px;
      text-transform: uppercase;
      position:relative;
      z-index:1;
    }
    .sb-header .col{ text-align:center; }
    .sb-header .left{ text-align:left; }

    .sb-row{
      display:grid;
      grid-template-columns: 86px 1fr 70px 70px;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      column-gap: 10px;
    }
    .sb-row:last-child{ border-bottom:none; }

    .tap{ touch-action: manipulation; }

    .sb-row.playerA{
      background:
        radial-gradient(520px 120px at 0% 50%, color-mix(in srgb, var(--pA) 32%, transparent), transparent 70%),
        linear-gradient(90deg,
          color-mix(in srgb, var(--pA) 68%, transparent),
          rgba(255,255,255,.03)
        );
    }
    .sb-row.playerB{
      background:
        radial-gradient(520px 120px at 0% 50%, color-mix(in srgb, var(--pB) 32%, transparent), transparent 70%),
        linear-gradient(90deg,
          color-mix(in srgb, var(--pB) 68%, transparent),
          rgba(255,255,255,.03)
        );
    }

    .serveCell{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      font-weight: 1200;
      opacity: .95;
      color: rgba(255,255,255,.96);
    }
    .serveCell.none{ opacity: 0; }

    .name{
      display:flex;
      align-items:center;
      min-height: 44px;
      font-size: var(--fs-name);
      font-weight: 1200;
      letter-spacing: .2px;
      min-width: 0;
    }
    .name span{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .num{
      text-align:center;
      font-size: var(--fs-num);
      font-weight: 1200;
      letter-spacing: .3px;
    }

    .badgeLine{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin: 12px 0 0;
      color: var(--muted);
      font-size: var(--fs-meta);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(120px 50px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.16));
      font-weight: 950;
    }

    .hint{
      margin-top: 10px;
      font-size: var(--fs-meta);
      color: rgba(255,255,255,.78);
    }

    .log{
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 12px;
      max-height: 190px;
      overflow: auto;
      margin-top: 10px;
    }

    /* ---- WIN MODAL ---- */
    .modalOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      z-index: 999;
      backdrop-filter: blur(6px);
    }
    .modalOverlay.show{ display:flex; }

    .modalCard{
      width: min(560px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      overflow:hidden;
      background:
        radial-gradient(900px 260px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(10,13,18,.95), rgba(16,20,27,.95));
    }
    .modalTop{
      padding: 14px 16px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--winColor) 28%, transparent),
        color-mix(in srgb, var(--winColor) 10%, transparent)
      );
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .shareBtn{
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow:none;
      font-size: 16px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .modalBody{
      padding: 18px 16px 16px;
    }
    .modalTitle{
      font-size: clamp(22px, 6vw, 34px);
      font-weight: 1200;
      line-height: 1.1;
      margin: 0 0 8px;
    }
    .modalSub{
      font-size: var(--fs-body);
      color: rgba(255,255,255,.80);
      margin: 0 0 12px;
    }
    .summaryBox{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px;
      margin: 12px 0 14px;
      line-height: 1.35;
      font-size: var(--fs-body);
    }
    .summaryRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,.18);
    }
    .summaryRow:last-child{ border-bottom:none; }

    .modalActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalActions button.primary{
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(180deg, var(--dartRedHi), var(--dartRed));
    }

    /* ---- FOOTER ---- */
    .footer{
      position:relative;
      z-index:1;
      margin-top: 18px;
      padding: 16px 0 4px;
      color: rgba(255,255,255,.82);
      font-size: var(--fs-meta);
      display:flex;
      justify-content:center;
    }
    .footerCard{
      width: min(980px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 12px;
    }
    .footerImg{
      width: 84px;
      height: 54px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.16);
      flex: 0 0 auto;
    }
    .footerText{ min-width: 0; line-height: 1.25; }
    .footerText strong{ color: rgba(255,255,255,.98); }
  </style>
</head>

<body>
<div class="wrap">

  <div class="main">
    <!-- SETUP -->
    <div id="screenSetup">
      <div class="navbar">
        <div class="brand">
          <img class="logoImg" id="topLogo" alt="Logo"
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='88' height='88' viewBox='0 0 88 88'%3E%3Crect x='6' y='6' width='76' height='76' rx='18' fill='%230b0f14'/%3E%3Ccircle cx='44' cy='44' r='28' fill='%23ffffff' fill-opacity='.10'/%3E%3Cpath d='M18 56 L50 24 L58 32 L26 64 Z' fill='%23ffffff' fill-opacity='.12'/%3E%3Cpath d='M50 24 L70 16 L74 20 L58 32 Z' fill='%23d61f26' fill-opacity='.38'/%3E%3Cpath d='M26 64 L58 32 L66 40 L34 72 Z' fill='%2314a44d' fill-opacity='.34'/%3E%3C/svg%3E" />
          <div class="brandTitle">Dart Set &amp; Leg Counter</div>
        </div>
        <div class="topActions"></div>
      </div>

      <div class="card hidden" id="resumeCard">
        <div style="font-weight:1100; margin-bottom:6px; position:relative; z-index:1;">Es gibt ein gespeichertes Match.</div>
        <div class="meta" id="resumeMeta" style="margin-top:0; position:relative; z-index:1;">‚Äî</div>
        <div class="controls" style="margin-top:12px; position:relative; z-index:1;">
          <button class="primary" id="resumeBtn" type="button">Fortsetzen</button>
          <button class="ghost" id="discardBtn" type="button">Match verwerfen</button>
        </div>
      </div>

      <div class="card">
        <label style="position:relative; z-index:1;">Spieler</label>
        <div class="playersList" id="playersList" style="position:relative; z-index:1;"></div>

        <div class="controls" style="margin-top:12px; position:relative; z-index:1;">
          <button class="ghost" id="addPlayer" type="button">+ Spieler hinzuf√ºgen</button>
          <span class="spacer"></span>
          <span class="meta" style="margin-top:0;">Farben sind nur einmal w√§hlbar.</span>
        </div>
        <div class="meta" style="position:relative; z-index:1;">Einstellungen werden gespeichert. (Match kann sp√§ter fortgesetzt werden.)</div>
      </div>

      <div class="card">
        <div class="controls" style="gap:12px; position:relative; z-index:1;">
          <div style="flex:1; min-width: 240px;">
            <label for="firstToSets">Sets (First to)</label>
            <select id="firstToSets"></select>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label for="legsToWinSet">Legs (First to)</label>
            <select id="legsToWinSet"></select>
          </div>
        </div>

        <div class="controls" style="gap:12px; margin-top:12px; position:relative; z-index:1;">
          <div style="flex:1; min-width: 240px;">
            <label for="firstServer">Anwurf in Set 1 / Leg 1</label>
            <select id="firstServer">
              <option value="A">Spieler 1</option>
              <option value="B">Spieler 2</option>
            </select>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label>&nbsp;</label>
            <div class="meta" id="formatHint" style="margin-top:0;"></div>
          </div>
        </div>

        <div class="controls" style="margin-top:14px; position:relative; z-index:1;">
          <button class="primary" id="startBtn" type="button">Spiel starten</button>
          <button class="ghost" id="quickHelpBtn" type="button">Kurzhilfe</button>
        </div>

        <div class="meta" id="helpText" style="display:none; position:relative; z-index:1;">
          Im Spiel: Tippen Sie auf die Spielerzeile = Leg +1. Langer Druck auf Spielerzeile = R√ºckg√§ngig.<br>
          Der ‚ñ∂-Pfeil zeigt den aktuellen Anwurf f√ºr das n√§chste Leg.
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="screenGame" class="hidden">
      <div class="navbar">
        <div class="brand">
          <img class="logoImg" alt="Logo" src="" id="topLogo2" />
          <div class="brandTitle">Dart Set &amp; Leg Counter</div>
        </div>
        <div class="topActions"></div>
      </div>

      <div class="card scoreboard">
        <div class="sb-header">
          <div class="col">ANWURF</div>
          <div class="left">NAME</div>
          <div class="col">SETS</div>
          <div class="col">LEGS</div>
        </div>

        <div class="sb-row tap playerA" id="rowA" role="button" aria-label="Leg gewonnen Spieler 1">
          <div class="serveCell" id="serveA">‚ñ∂</div>
          <div class="name"><span id="titleA">Spieler 1</span></div>
          <div class="num" id="setsA">0</div>
          <div class="num" id="legsA">0</div>
        </div>

        <div class="sb-row tap playerB" id="rowB" role="button" aria-label="Leg gewonnen Spieler 2">
          <div class="serveCell" id="serveB">‚ñ∂</div>
          <div class="name"><span id="titleB">Spieler 2</span></div>
          <div class="num" id="setsB">0</div>
          <div class="num" id="legsB">0</div>
        </div>

        <div style="padding:12px 14px; position:relative; z-index:1;">
          <div class="badgeLine">
            <span class="pill" id="setsPill"></span>
            <span class="pill" id="legsPill"></span>
          </div>

          <div class="controls" style="margin-top:12px;">
            <button class="ghost" id="undo" type="button">R√ºckg√§ngig</button>
            <button class="primary" id="saveResume" type="button">Speichern &amp; sp√§ter fortsetzen</button>
            <span class="spacer"></span>
            <button class="ghost small" id="toggleLog" type="button" aria-expanded="false">Verlauf anzeigen</button>
          </div>

          <div class="log hidden" id="log"></div>
          <div class="hint">Anwurf (‚ñ∂) wechselt automatisch pro Leg und pro Set.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer" aria-label="Footer">
    <div class="footerCard">
      <img class="footerImg" id="footerImg" alt="Dart Gimmick"
           src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='168' height='108' viewBox='0 0 168 108'%3E%3Crect width='168' height='108' rx='22' fill='%230b0f14'/%3E%3Ccircle cx='130' cy='38' r='44' fill='%23ffffff' fill-opacity='.07'/%3E%3Cpath d='M22 78 L82 18 L92 28 L32 88 Z' fill='%23ffffff' fill-opacity='.12'/%3E%3Cpath d='M82 18 L118 8 L124 14 L92 28 Z' fill='%23d61f26' fill-opacity='.42'/%3E%3Cpath d='M32 88 L92 28 L102 38 L42 98 Z' fill='%2314a44d' fill-opacity='.38'/%3E%3C/svg%3E" />
      <div class="footerText">
        <strong>Der Counter wird dir bereitgestellt von Nici (den aber jeder leider nur Nico nennt)</strong><br><br>
        Viel Spa√ü beim Spielen und auf das ein oder andere Spa√ügetr√§nk! üçª
      </div>
    </div>
  </footer>

</div>

<!-- WIN MODAL -->
<div class="modalOverlay" id="winModal" role="dialog" aria-modal="true" aria-label="Match beendet">
  <div class="modalCard" style="--winColor: var(--pA);">
    <div class="modalTop">
      <span class="tag" id="winTag">üèÜ Match beendet</span>
      <button class="shareBtn ghost" id="shareBtn" type="button" aria-label="Ergebnis teilen">üì§ Teilen</button>
    </div>
    <div class="modalBody">
      <h2 class="modalTitle" id="winTitle">Gl√ºckwunsch!</h2>
      <p class="modalSub" id="winSub">Sie haben das Match gewonnen.</p>

      <div class="summaryBox" id="winSummary"></div>

      <div class="modalActions">
        <button class="primary" id="winRevenge" type="button">Revanche</button>
        <button class="ghost" id="winToSetup" type="button">Zum Setup</button>
      </div>
    </div>
  </div>
</div>

<script>
  const SETTINGS_KEY = "dart_counter_settings_v19";
  const MATCH_KEY    = "dart_counter_match_v19";

  const APP_URL = "https://nicoloehle.github.io/dart-counter/";

  /* Farben sortiert (Dart-Style -> warm/knallig -> dunkler) */
  const COLOR_OPTIONS = [
    { key: "red",      name: "Rot",        hex: "#d61f26" },
    { key: "green",    name: "Gr√ºn",       hex: "#14a44d" },
    { key: "yellow",   name: "Gelb",       hex: "#f2c230" },
    { key: "orange",   name: "Orange",     hex: "#f97316" },
    { key: "pink",     name: "Pink",       hex: "#ff3ea5" },
    { key: "violet",   name: "Violett",    hex: "#7c3aed" },
    { key: "blue",     name: "Blau",       hex: "#2f6bff" },
    { key: "darkblue", name: "Dunkelblau", hex: "#1e3a8a" },
    { key: "brown",    name: "Braun",      hex: "#7a4a2e" }
  ];

  const el = (id) => document.getElementById(id);
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const other = (p) => (p === "A" ? "B" : "A");

  function haptic(ms = 14) { try { if (navigator.vibrate) navigator.vibrate(ms); } catch(_){} }

  /* ---------- Sounds (WebAudio) ---------- */
  let audioCtx = null;
  function ensureAudio(){
    if(audioCtx) return;
    try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    catch(_){ audioCtx = null; }
  }
  function beep(freq=520, ms=45, type="sine", gain=0.05){
    try{
      ensureAudio();
      if(!audioCtx) return;
      if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); setTimeout(()=>{ try{o.stop();}catch(_){} }, ms);
    }catch(_){}
  }
  const sfx = {
    tap(){ beep(520, 40, "sine", 0.045); },
    undo(){ beep(260, 60, "triangle", 0.05); },
    set(){ beep(740, 70, "square", 0.04); },
    win(){ beep(880, 90, "sine", 0.055); setTimeout(()=>beep(1040, 110, "sine", 0.05), 90); },
    ui(){  beep(420, 35, "sine", 0.035); }
  };

  const state = {
    players: [
      { id: "p1", name: "", color: "#d61f26" },
      { id: "p2", name: "", color: "#14a44d" }
    ],
    firstToSets: 3,
    legsToWinSet: 3,
    firstServer: "A",
    match: {
      inProgress: false,
      matchOver: false,
      sets: { A: 0, B: 0 },
      legs: { A: 0, B: 0 },
      legsTotal: { A: 0, B: 0 },
      history: []
    }
  };

  function getP1(){ return state.players[0] || { id:"p1", name:"", color:"#d61f26" }; }
  function getP2(){ return state.players[1] || { id:"p2", name:"", color:"#14a44d" }; }
  function playerName(p, fallback){ const n=(p?.name||"").trim(); return n ? n : fallback; }

  function syncLogos(){
    const src = el("topLogo")?.getAttribute("src") || "";
    if(el("topLogo2")) el("topLogo2").setAttribute("src", src);
  }

  /* ---------- Colors unique ---------- */
  function usedColors(exceptId=null){
    const used = new Set();
    for(const p of state.players){
      if(exceptId && p.id === exceptId) continue;
      used.add((p.color||"").toLowerCase());
    }
    return used;
  }
  function firstFreeColor(usedSet){
    const found = COLOR_OPTIONS.find(c => !usedSet.has(c.hex.toLowerCase()));
    return found ? found.hex : COLOR_OPTIONS[0].hex;
  }
  function enforceUniqueColorsAll(){
    const seen = new Set();
    for(const p of state.players){
      const c = (p.color||"").toLowerCase();
      if(!c || seen.has(c)){
        const used = usedColors(p.id);
        p.color = firstFreeColor(used);
      }
      seen.add(p.color.toLowerCase());
    }
  }
  function applyP1P2ColorsToCSS(){
    const p1 = getP1(), p2 = getP2();
    document.documentElement.style.setProperty("--pA", p1.color || "#d61f26");
    document.documentElement.style.setProperty("--pB", p2.color || "#14a44d");
  }

  /* ---------- Persist ---------- */
  function saveSettings(){
    try{
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({
        players: state.players,
        firstToSets: state.firstToSets,
        legsToWinSet: state.legsToWinSet,
        firstServer: state.firstServer,
        logoSrc: el("topLogo")?.getAttribute("src") || "",
        footerSrc: el("footerImg")?.getAttribute("src") || ""
      }));
    }catch(_){}
  }
  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return;
      const s = JSON.parse(raw);

      if(Array.isArray(s.players) && s.players.length >= 2){
        state.players = s.players.map((p, i)=>({
          id: (typeof p.id === "string" && p.id) ? p.id : ("p"+(i+1)),
          name: (typeof p.name === "string") ? p.name : "",
          color: (typeof p.color === "string" && p.color) ? p.color : COLOR_OPTIONS[i % COLOR_OPTIONS.length].hex
        }));
      }
      state.firstToSets  = Number.isFinite(+s.firstToSets) ? Math.min(7, Math.max(1, +s.firstToSets)) : state.firstToSets;
      state.legsToWinSet = Number.isFinite(+s.legsToWinSet) ? Math.min(7, Math.max(1, +s.legsToWinSet)) : state.legsToWinSet;
      state.firstServer  = (s.firstServer === "B") ? "B" : "A";

      if(typeof s.logoSrc === "string" && s.logoSrc) el("topLogo").setAttribute("src", s.logoSrc);
      if(typeof s.footerSrc === "string" && s.footerSrc) el("footerImg").setAttribute("src", s.footerSrc);
      syncLogos();

      enforceUniqueColorsAll();
    }catch(_){}
  }

  function saveMatch(){
    try{
      localStorage.setItem(MATCH_KEY, JSON.stringify({
        inProgress: state.match.inProgress,
        matchOver: state.match.matchOver,
        sets: state.match.sets,
        legs: state.match.legs,
        legsTotal: state.match.legsTotal,
        history: state.match.history,
        firstToSets: state.firstToSets,
        legsToWinSet: state.legsToWinSet,
        firstServer: state.firstServer
      }));
    }catch(_){}
  }
  function loadMatch(){
    try{
      const raw = localStorage.getItem(MATCH_KEY);
      if(!raw) return false;
      const m = JSON.parse(raw);
      if(!m || !m.inProgress) return false;

      state.match.inProgress = !!m.inProgress;
      state.match.matchOver  = !!m.matchOver;
      state.match.sets       = m.sets || state.match.sets;
      state.match.legs       = m.legs || state.match.legs;
      state.match.legsTotal  = m.legsTotal || state.match.legsTotal;
      state.match.history    = Array.isArray(m.history) ? m.history : [];

      state.firstToSets  = Number.isFinite(+m.firstToSets) ? Math.min(7, Math.max(1, +m.firstToSets)) : state.firstToSets;
      state.legsToWinSet = Number.isFinite(+m.legsToWinSet) ? Math.min(7, Math.max(1, +m.legsToWinSet)) : state.legsToWinSet;
      state.firstServer  = (m.firstServer === "B") ? "B" : "A";

      return (state.match.inProgress && !state.match.matchOver);
    }catch(_){ return false; }
  }
  function clearMatchStorage(){ try{ localStorage.removeItem(MATCH_KEY); }catch(_){} }

  /* ---------- Setup rendering ---------- */
  let openPaletteFor = null;

  function renderPlayers(){
    const list = el("playersList");
    list.innerHTML = "";

    state.players.forEach((p, idx)=>{
      const row = document.createElement("div");
      row.className = "playerRow";

      const top = document.createElement("div");
      top.className = "playerRowTop";

      const colorBtn = document.createElement("button");
      colorBtn.type = "button";
      colorBtn.className = "colorPickBtn";
      colorBtn.style.setProperty("--dot", p.color);
      colorBtn.setAttribute("aria-label", `Farbe f√ºr Spieler ${idx+1} w√§hlen`);
      colorBtn.addEventListener("click", ()=>{
        openPaletteFor = (openPaletteFor === p.id) ? null : p.id;
        renderPlayers();
        haptic(8); sfx.ui();
      });

      const input = document.createElement("input");
      input.placeholder = `Spieler ${idx+1}`;
      input.value = (typeof p.name === "string") ? p.name : "";
      input.addEventListener("input", ()=>{
        p.name = input.value;
        saveSettings();
        if(state.match.inProgress) renderGame();
      });

      let rightEl = document.createElement("div");
      if(idx >= 2){
        const trash = document.createElement("button");
        trash.type = "button";
        trash.className = "trashBtn ghost";
        trash.textContent = "üóëÔ∏è";
        trash.title = "Spieler entfernen";
        trash.addEventListener("click", ()=>{
          state.players = state.players.filter(x=>x.id !== p.id);
          openPaletteFor = null;
          enforceUniqueColorsAll();
          saveSettings();
          applyP1P2ColorsToCSS();
          renderPlayers();
          haptic(12); sfx.ui();
        });
        rightEl = trash;
      }

      top.appendChild(colorBtn);
      top.appendChild(input);
      top.appendChild(rightEl);
      row.appendChild(top);

      if(openPaletteFor === p.id){
        const pal = document.createElement("div");
        pal.className = "palette";
        const used = usedColors(p.id);

        COLOR_OPTIONS.forEach(c=>{
          const sw = document.createElement("button");
          sw.type = "button";
          sw.className = "swatch";
          sw.style.setProperty("--c", c.hex);

          const check = document.createElement("span");
          check.className = "check";
          check.textContent = "‚úì";
          sw.appendChild(check);

          const hex = c.hex.toLowerCase();
          const isSelected = hex === (p.color||"").toLowerCase();
          const isTaken = used.has(hex) && !isSelected;

          sw.classList.toggle("selected", isSelected);
          sw.classList.toggle("taken", isTaken);

          sw.addEventListener("click", ()=>{
            if(isTaken) return;
            p.color = c.hex;
            enforceUniqueColorsAll();
            saveSettings();
            applyP1P2ColorsToCSS();
            if(state.match.inProgress) renderGame();
            renderPlayers();
            haptic(10); sfx.ui();
          });

          pal.appendChild(sw);
        });

        row.appendChild(pal);
      }

      list.appendChild(row);
    });
  }

  document.addEventListener("pointerdown", (e)=>{
    if(!openPaletteFor) return;
    const inside = e.target.closest(".palette") || e.target.closest(".colorPickBtn") || e.target.closest(".swatch");
    if(!inside){
      openPaletteFor = null;
      renderPlayers();
    }
  }, { passive: true });

  function fillOneToSeven(selectEl, defaultVal){
    selectEl.innerHTML = "";
    for(let i=1;i<=7;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      if(i === defaultVal) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }

  function renderSetupHint(){
    const sets = +el("firstToSets").value;
    const legs = +el("legsToWinSet").value;
    const starter = el("firstServer").value === "B" ? "Spieler 2" : "Spieler 1";
    el("formatHint").textContent =
      `Match: First to ${sets} Sets ¬∑ Set: First to ${legs} Legs ¬∑ Anwurf Start: ${starter}`;
  }

  function show(screen){
    el("screenSetup").classList.toggle("hidden", screen !== "setup");
    el("screenGame").classList.toggle("hidden", screen !== "game");
    openPaletteFor = null;
    renderPlayers();
  }

  /* ---------- Game logic ---------- */
  function logLine(t){
    const prev = el("log").textContent || "";
    const sep = prev.trim().length ? "\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n" : "";
    el("log").textContent = t + sep + prev;
  }

  function currentSetNumber(){ return state.match.sets.A + state.match.sets.B + 1; }
  function currentLegNumberWithinSet(){ return state.match.legs.A + state.match.legs.B + 1; }

  function computeThrower(){
    const setNo = currentSetNumber();
    const setStarter = (setNo % 2 === 1) ? state.firstServer : other(state.firstServer);
    const legNo = currentLegNumberWithinSet();
    return (legNo % 2 === 1) ? setStarter : other(setStarter);
  }

  function renderGame(){
    const p1 = getP1(), p2 = getP2();
    applyP1P2ColorsToCSS();

    el("titleA").textContent = playerName(p1, "Spieler 1");
    el("titleB").textContent = playerName(p2, "Spieler 2");

    el("setsA").textContent = state.match.sets.A;
    el("setsB").textContent = state.match.sets.B;
    el("legsA").textContent = state.match.legs.A;
    el("legsB").textContent = state.match.legs.B;

    el("setsPill").textContent = `Sets: First to ${state.firstToSets}`;
    el("legsPill").textContent  = `Legs/Set: First to ${state.legsToWinSet}`;

    const thrower = computeThrower();
    el("serveA").classList.toggle("none", thrower !== "A");
    el("serveB").classList.toggle("none", thrower !== "B");

    saveMatch();
  }

  function snapshot(){
    state.match.history.push(JSON.parse(JSON.stringify({
      inProgress: state.match.inProgress,
      matchOver: state.match.matchOver,
      sets: state.match.sets,
      legs: state.match.legs,
      legsTotal: state.match.legsTotal,
      firstToSets: state.firstToSets,
      legsToWinSet: state.legsToWinSet,
      firstServer: state.firstServer
    })));
    if(state.match.history.length > 80) state.match.history.shift();
    saveMatch();
  }

  function formatShareText(){
    const p1 = getP1(), p2 = getP2();
    const n1 = playerName(p1,"Spieler 1");
    const n2 = playerName(p2,"Spieler 2");

    const setsLine = `üèÜ Sets: ${n1} ${state.match.sets.A} ‚Äî ${state.match.sets.B} ${n2}`;
    const legsLine = `üéØ Legs (gesamt): ${n1} ${state.match.legsTotal.A} ‚Äî ${state.match.legsTotal.B} ${n2}`;
    const formatLine = `‚öôÔ∏è Format: First to ${state.firstToSets} Sets ¬∑ First to ${state.legsToWinSet} Legs`;
    const promoLine = `‚ú® Counter ausprobieren: ${APP_URL}`;

    return [
      "üéØ Dart Set & Leg Counter",
      "",
      setsLine,
      legsLine,
      formatLine,
      "",
      "üçª Viel Spa√ü beim Spielen!",
      promoLine
    ].join("\n");
  }

  function showWinModal(winner){
    state.match.matchOver = true;
    state.match.inProgress = false;

    const p1 = getP1(), p2 = getP2();
    const winnerName = winner === "A" ? playerName(p1, "Spieler 1") : playerName(p2, "Spieler 2");
    const winColor = winner === "A" ? (p1.color || "#d61f26") : (p2.color || "#14a44d");

    const modal = el("winModal");
    const card = modal.querySelector(".modalCard");
    card.style.setProperty("--winColor", winColor);

    el("winTitle").textContent = `Gl√ºckwunsch ${winnerName}!`;
    el("winSub").textContent = "Sie haben das Match gewonnen.";

    const n1 = playerName(p1, "Spieler 1");
    const n2 = playerName(p2, "Spieler 2");
    el("winSummary").innerHTML = `
      <div class="summaryRow"><div>Ergebnis (Sets)</div><div>${n1}: ${state.match.sets.A} ¬∑ ${n2}: ${state.match.sets.B}</div></div>
      <div class="summaryRow"><div>Legs (gesamt)</div><div>${n1}: ${state.match.legsTotal.A} ¬∑ ${n2}: ${state.match.legsTotal.B}</div></div>
      <div class="summaryRow"><div>Format</div><div>First to ${state.firstToSets} Sets ¬∑ First to ${state.legsToWinSet} Legs</div></div>
      <div class="summaryRow"><div>App</div><div><span style="opacity:.95;">${APP_URL}</span></div></div>
    `;

    modal.classList.add("show");
    haptic(40); sfx.win();
    saveMatch();
  }
  function hideWinModal(){ el("winModal").classList.remove("show"); }

  function finishMatchIfNeeded(player){
    if(state.match.sets[player] >= state.firstToSets){
      showWinModal(player);
      return true;
    }
    return false;
  }

  function awardSet(player){
    state.match.sets[player] += 1;
    state.match.legs.A = 0;
    state.match.legs.B = 0;

    const p1 = getP1(), p2 = getP2();
    logLine(`Set an ${(player==="A") ? playerName(p1,"Spieler 1") : playerName(p2,"Spieler 2")} ‚Äî Sets: ${state.match.sets.A}-${state.match.sets.B}`);
    sfx.set();
    saveMatch();

    finishMatchIfNeeded(player);
  }

  function addLeg(player){
    if(state.match.matchOver) return;
    snapshot();

    state.match.legs[player] += 1;
    state.match.legsTotal[player] += 1;
    haptic(12); sfx.tap();

    const p1 = getP1(), p2 = getP2();
    logLine(`Leg an ${(player==="A") ? playerName(p1,"Spieler 1") : playerName(p2,"Spieler 2")} ‚Äî Legs: ${state.match.legs.A}-${state.match.legs.B}`);

    if(state.match.legs[player] >= state.legsToWinSet){
      awardSet(player);
      if(state.match.matchOver){ renderGame(); return; }
    }
    renderGame();
  }

  function undo(){
    if(state.match.matchOver) return;
    const prev = state.match.history.pop();
    if(!prev) return;

    state.match.inProgress = prev.inProgress;
    state.match.matchOver  = prev.matchOver;
    state.match.sets       = prev.sets;
    state.match.legs       = prev.legs;
    state.match.legsTotal  = prev.legsTotal;

    state.firstToSets  = prev.firstToSets;
    state.legsToWinSet = prev.legsToWinSet;
    state.firstServer  = prev.firstServer;

    el("firstToSets").value  = String(state.firstToSets);
    el("legsToWinSet").value = String(state.legsToWinSet);
    el("firstServer").value  = state.firstServer;

    haptic(10); sfx.undo();
    logLine("R√ºckg√§ngig.");
    renderGame();
    saveMatch();
  }

  function toggleLog(){
    el("log").classList.toggle("hidden");
    const vis = !el("log").classList.contains("hidden");
    el("toggleLog").textContent = vis ? "Verlauf ausblenden" : "Verlauf anzeigen";
    el("toggleLog").setAttribute("aria-expanded", String(vis));
    haptic(8); sfx.ui();
  }

  function attachTapAndLongPress(targetEl, onTap, onLongPress){
    const LONG = 450;
    let timer = null;
    let didLong = false;

    const clear = () => { if(timer) clearTimeout(timer); timer = null; };

    targetEl.addEventListener("pointerdown", () => {
      didLong = false; clear();
      timer = setTimeout(() => { didLong = true; onLongPress(); }, LONG);
    }, { passive: true });

    targetEl.addEventListener("pointerup", () => {
      if(!didLong) onTap();
      clear();
    });

    targetEl.addEventListener("pointercancel", clear);
    targetEl.addEventListener("pointerleave", clear);
    targetEl.addEventListener("contextmenu", (e)=> e.preventDefault());
  }

  function showResumeUIIfNeeded(){
    const has = loadMatch();
    if(has){
      const p1 = getP1(), p2 = getP2();
      el("resumeMeta").textContent =
        `${playerName(p1,"Spieler 1")} vs ${playerName(p2,"Spieler 2")} ¬∑ Sets ${state.match.sets.A}-${state.match.sets.B} ¬∑ Legs ${state.match.legs.A}-${state.match.legs.B}`;
      el("resumeCard").classList.remove("hidden");
    }else{
      el("resumeCard").classList.add("hidden");
    }
  }

  async function shareResult(){
    const text = formatShareText();
    try{
      if(navigator.share){
        await navigator.share({ title: "Dart Ergebnis", text, url: APP_URL });
      }else if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        alert("Ergebnis kopiert ‚Äì Sie k√∂nnen es jetzt z.B. in WhatsApp einf√ºgen.");
      }else{
        prompt("Kopieren Sie das Ergebnis:", text);
      }
      haptic(10); sfx.ui();
    }catch(_){}
  }

  function resetMatchScores(){
    state.match.inProgress = true;
    state.match.matchOver = false;
    state.match.sets = { A: 0, B: 0 };
    state.match.legs = { A: 0, B: 0 };
    state.match.legsTotal = { A: 0, B: 0 };
    state.match.history = [];
    el("log").textContent = "";
    hideWinModal();
    saveMatch();
    renderGame();
  }

  function startMatch(){
    state.firstToSets  = +el("firstToSets").value;
    state.legsToWinSet = +el("legsToWinSet").value;
    state.firstServer  = (el("firstServer").value === "B") ? "B" : "A";

    state.match.inProgress = true;
    state.match.matchOver = false;
    state.match.sets = { A: 0, B: 0 };
    state.match.legs = { A: 0, B: 0 };
    state.match.legsTotal = { A: 0, B: 0 };
    state.match.history = [];
    el("log").textContent = "";

    const p1 = getP1(), p2 = getP2();
    logLine(`Start: ${playerName(p1,"Spieler 1")} vs ${playerName(p2,"Spieler 2")} ‚Äî First to ${state.firstToSets} Sets ‚Äî First to ${state.legsToWinSet} Legs ‚Äî Anwurf: ${(state.firstServer==="A") ? "Spieler 1" : "Spieler 2"}`);

    el("log").classList.add("hidden");
    el("toggleLog").textContent = "Verlauf anzeigen";
    el("toggleLog").setAttribute("aria-expanded","false");

    saveSettings();
    saveMatch();
    renderGame();
    haptic(12); sfx.ui();
    show("game");
  }

  function saveAndReturnToSetup(){
    saveSettings();
    saveMatch();
    showResumeUIIfNeeded();
    show("setup");
    haptic(10); sfx.ui();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    document.addEventListener("pointerdown", ()=>ensureAudio(), { once:true, passive:true });

    syncLogos();
    loadSettings();
    syncLogos();

    fillOneToSeven(el("firstToSets"), state.firstToSets);
    fillOneToSeven(el("legsToWinSet"), state.legsToWinSet);

    el("firstServer").value  = state.firstServer;

    enforceUniqueColorsAll();
    applyP1P2ColorsToCSS();
    renderPlayers();
    renderSetupHint();
    showResumeUIIfNeeded();

    el("addPlayer").addEventListener("click", ()=>{
      if(state.players.length >= COLOR_OPTIONS.length){
        alert("Maximale Spieleranzahl erreicht (entspricht Anzahl verf√ºgbarer Farben).");
        return;
      }
      const used = usedColors(null);
      const newColor = firstFreeColor(used);
      state.players.push({ id: uid(), name: "", color: newColor });
      enforceUniqueColorsAll();
      saveSettings();
      renderPlayers();
      haptic(12); sfx.ui();
    });

    ["firstToSets","legsToWinSet","firstServer"].forEach(id=>{
      el(id).addEventListener("change", ()=>{
        state.firstToSets  = +el("firstToSets").value;
        state.legsToWinSet = +el("legsToWinSet").value;
        state.firstServer  = (el("firstServer").value === "B") ? "B" : "A";
        saveSettings();
        renderSetupHint();
        sfx.ui();
      });
    });

    el("quickHelpBtn").addEventListener("click", ()=>{
      const t = el("helpText");
      t.style.display = (t.style.display === "none") ? "block" : "none";
      haptic(8); sfx.ui();
    });

    el("startBtn").addEventListener("click", startMatch);

    attachTapAndLongPress(el("rowA"), () => addLeg("A"), undo);
    attachTapAndLongPress(el("rowB"), () => addLeg("B"), undo);

    el("undo").addEventListener("click", undo);
    el("toggleLog").addEventListener("click", toggleLog);

    el("saveResume").addEventListener("click", saveAndReturnToSetup);

    el("resumeBtn").addEventListener("click", ()=>{
      if(!loadMatch()){ showResumeUIIfNeeded(); return; }
      show("game");
      renderGame();
      haptic(10); sfx.ui();
    });

    el("discardBtn").addEventListener("click", ()=>{
      haptic(10); sfx.ui();
      if(confirm("Gespeichertes Match wirklich verwerfen?")){
        clearMatchStorage();
        state.match.inProgress = false;
        state.match.matchOver = false;
        state.match.history = [];
        showResumeUIIfNeeded();
      }
    });

    el("shareBtn").addEventListener("click", shareResult);

    el("winRevenge").addEventListener("click", ()=>{
      resetMatchScores();
      haptic(14); sfx.ui();
    });

    el("winToSetup").addEventListener("click", ()=>{
      hideWinModal();
      clearMatchStorage();
      state.match.inProgress = false;
      state.match.matchOver = false;
      state.match.history = [];
      showResumeUIIfNeeded();
      show("setup");
      haptic(10); sfx.ui();
    });

    el("winModal").addEventListener("click", (e)=>{
      if(e.target === el("winModal")){ e.preventDefault(); e.stopPropagation(); }
    });
  });
</script>
</body>
</html>