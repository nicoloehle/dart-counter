<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b8161c" />
  <title>Dart Set &amp; Leg Counter</title>

  <style>
    :root{
      --radius:18px;
      --tap: 56px;

      --fs-title: clamp(18px, 4.6vw, 26px);
      --fs-body:  clamp(15px, 4vw, 18px);
      --fs-meta:  clamp(12px, 3.3vw, 14px);

      --fs-name:  clamp(18px, 4.8vw, 22px);
      --fs-col:   clamp(12px, 3.2vw, 13px);
      --fs-num:   clamp(20px, 5.4vw, 26px);

      /* Dart style */
      --dartRed:   #b8161c;
      --dartRedHi: #ff3a41;
      --dartGreen: #0f7a2b;

      --panelA: rgba(10,13,18,.94);
      --panelB: rgba(16,20,27,.94);
      --panelEdge: rgba(255,255,255,.16);
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      --text:#f7f8fb;
      --muted: rgba(247,248,251,.82);

      --inputBg: rgba(0,0,0,.30);

      /* Player highlight colors for background accents */
      --pA: #d61f26;
      --pB: #14a44d;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow-x:hidden; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--dartGreen);
      padding:
        max(14px, env(safe-area-inset-top))
        max(14px, env(safe-area-inset-right))
        max(14px, env(safe-area-inset-bottom))
        max(14px, env(safe-area-inset-left));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      min-height: 100%;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow-x: clip;
    }

    .wrap::before{
      content:"";
      position:absolute;
      inset:-140px;
      pointer-events:none;
      opacity:.22;
      background-image:
        radial-gradient(circle at 18% 22%, rgba(255,255,255,.18), transparent 42%),
        radial-gradient(circle at 82% 30%, rgba(0,0,0,.26), transparent 46%),
        repeating-conic-gradient(from 18deg,
          rgba(255,255,255,.10) 0 10deg,
          transparent 10deg 18deg),
        repeating-linear-gradient(45deg, rgba(0,0,0,.18) 0 8px, transparent 8px 22px);
      mix-blend-mode: overlay;
      filter: blur(1.2px);
      z-index:0;
    }

    .main{ position:relative; z-index:1; flex:1; }

    /* NAVBAR */
    .navbar{
      position: sticky;
      top: max(0px, env(safe-area-inset-top));
      z-index: 10;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.20);
      background: linear-gradient(180deg, var(--dartRedHi), var(--dartRed));
      box-shadow: 0 16px 34px rgba(0,0,0,.28);
      padding: 10px 12px;
      margin: 0 0 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }

    /* ‚úÖ Nur fixe Breite, keine fixe H√∂he ‚Äì keine Verzerrung */
    .logoImg{
      width: 44px;
      height: auto;
      aspect-ratio: 1 / 1;   /* verhindert Layout-Sprung, bleibt quadratisch */
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.26);
      background: rgba(0,0,0,.18);
      flex: 0 0 auto;
      object-fit: contain;   /* nichts wird abgeschnitten / verzerrt */
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }

    .brandTitle{
      font-size: var(--fs-title);
      font-weight: 1200;
      letter-spacing: .2px;
      line-height: 1.12;
      color: #fff;
      text-shadow: 0 10px 20px rgba(0,0,0,.22);
      white-space: normal;
      word-break: break-word;
    }

    .card{
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid var(--panelEdge);
      background:
        radial-gradient(900px 260px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 300px at 0% 100%, rgba(0,0,0,.28), transparent 58%),
        linear-gradient(180deg, var(--panelA), var(--panelB));
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      position:relative;
      overflow:hidden;
    }

    .card.compact{ padding: 12px 14px; }

    label{ display:block; font-size: var(--fs-meta); color: var(--muted); margin: 0 0 6px; }

    input, select{
      width:100%;
      font-size: var(--fs-body);
      padding: 12px;
      min-height: var(--tap);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: var(--inputBg);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: rgba(255,255,255,.55); }

    .meta{ color: var(--muted); font-size: var(--fs-meta); margin-top: 10px; line-height:1.35; }

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(140px 85px at 30% 25%, rgba(255,255,255,.14), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      min-height: var(--tap);
      font-size: var(--fs-body);
      font-weight: 950;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px) scale(.99); }

    button.primary{
      border-color: rgba(255,255,255,.24);
      background:
        radial-gradient(160px 95px at 30% 25%, rgba(255,255,255,.18), transparent 64%),
        linear-gradient(180deg, var(--dartRedHi), var(--dartRed));
      color:#fff;
      box-shadow: 0 16px 30px rgba(0,0,0,.22);
    }

    button.ghost{
      box-shadow:none;
      background:
        radial-gradient(140px 85px at 30% 25%, rgba(255,255,255,.10), transparent 62%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
    }

    button.small{
      min-height: 40px;
      padding: 8px 10px;
      font-size: var(--fs-meta);
      border-radius: 999px;
      box-shadow:none;
    }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }
    .hidden{ display:none!important; }

    /* SETUP ‚Äì Players */
    .playersList{ display:grid; gap: 12px; }

    .playerRow{
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(260px 140px at 25% 15%, rgba(255,255,255,.08), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      border-radius: 14px;
      padding: 10px;
      display:grid;
      gap: 10px;
      position:relative;
      overflow:hidden;
    }

    .playerRowTop{
      display:grid;
      grid-template-columns: 48px 1fr 44px;
      gap: 10px;
      align-items:center;
      position:relative;
      z-index:1;
    }

    .colorPickBtn{
      width: 48px;
      height: 48px;
      min-height: 48px;
      padding: 0;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:none;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.22);
    }
    .colorPickBtn::after{
      content:"";
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.78);
      background: var(--dot, #fff);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }

    .trashBtn{
      min-height: 44px;
      padding: 8px 10px;
      border-radius: 12px;
      box-shadow:none;
      font-size: 18px;
    }

    .palette{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      position:relative;
      z-index:1;
    }

    .swatch{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.24);
      background: var(--c);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      min-height: 34px;
      box-shadow:none;
      position: relative;
      overflow:hidden;
    }
    .swatch.selected{
      outline: 3px solid rgba(255,255,255,.42);
      outline-offset: 2px;
    }
    /* ‚úÖ "durchgestrichen" statt ausgegraut */
    .swatch.taken{
      opacity: .95;
      cursor: not-allowed;
      filter: none;
    }
    .swatch.taken::after{
      content:"";
      position:absolute;
      inset:-6px;
      background:
        linear-gradient(135deg,
          transparent 47%,
          rgba(255,255,255,.92) 48%,
          rgba(255,255,255,.92) 52%,
          transparent 53%);
      opacity: .9;
      pointer-events:none;
    }
    .swatch .check{
      font-size: 16px;
      line-height: 1;
      opacity: 0;
      transform: translateY(-1px);
      color: rgba(255,255,255,.96);
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    .swatch.selected .check{ opacity: 1; }

    /* SCOREBOARD */
    .scoreboard{ padding: 0; overflow:hidden; }

    /* ‚úÖ Header: hellgrau vollfl√§chig, kein Verlauf */
    .sb-header{
      display:grid;
      grid-template-columns: 86px 1fr 70px 70px;
      align-items:center;
      padding: 10px 14px;
      background: #e6e8ec;   /* hellgrau */
      border-bottom: 1px solid rgba(0,0,0,.10);
      column-gap: 12px;      /* ‚úÖ mehr Abstand, kein √úberlappen */
      position:relative;
    }
    .sb-header .col, .sb-header .left{
      font-size: var(--fs-col);
      color: rgba(11,15,20,.92);
      font-weight: 1200;
      letter-spacing: .28px;
      text-transform: uppercase; /* ‚úÖ einheitlich */
      position:relative;
      z-index:1;
    }
    .sb-header .col{ text-align:center; }
    .sb-header .left{ text-align:left; }

    .sb-row{
      display:grid;
      grid-template-columns: 86px 1fr 70px 70px;
      align-items:stretch;
      padding: 0;
      border-bottom: 1px solid rgba(255,255,255,.10);
      column-gap: 12px;
      background: rgba(255,255,255,.03);
    }
    .sb-row:last-child{ border-bottom:none; }

    .sb-row.playerDyn{
      background:
        radial-gradient(520px 120px at 0% 50%, color-mix(in srgb, var(--rowColor) 46%, transparent), transparent 70%),
        linear-gradient(90deg,
          color-mix(in srgb, var(--rowColor) 80%, transparent),
          rgba(255,255,255,.03)
        );
    }

    /* ‚úÖ Anwurf Zelle IMMER mit schwarzem Hintergrund */
    .serveCell{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      font-weight: 1200;
      color: rgba(255,255,255,.96);
      background: rgba(0,0,0,.72);
      border-right: 1px solid rgba(255,255,255,.10);
      padding: 12px 0;
      min-height: 64px;
    }
    .serveCell.none{ opacity: 0; }

    .name{
      display:flex;
      align-items:center;
      min-height: 64px;
      font-size: var(--fs-name);
      font-weight: 1200;
      letter-spacing: .2px;
      min-width: 0;
      padding: 12px 0;
    }
    .name span{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .num{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: var(--fs-num);
      font-weight: 1200;
      letter-spacing: .3px;
      padding: 12px 0;
      min-height: 64px;
    }

    .badgeLine{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin: 12px 0 0;
      color: var(--muted);
      font-size: var(--fs-meta);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(120px 50px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.16));
      font-weight: 950;
    }

    .hint{
      margin-top: 10px;
      font-size: var(--fs-meta);
      color: rgba(255,255,255,.78);
    }

    .log{
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 12px;
      max-height: 190px;
      overflow: auto;
      margin-top: 10px;
    }

    /* MODAL */
    .modalOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      z-index: 999;
      backdrop-filter: blur(6px);
    }
    .modalOverlay.show{ display:flex; }

    .modalCard{
      width: min(560px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      overflow:hidden;
      background: linear-gradient(180deg, var(--panelA), var(--panelB));
    }
    .modalTop{
      padding: 14px 16px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--winColor) 28%, transparent),
        color-mix(in srgb, var(--winColor) 10%, transparent)
      );
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTop .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: var(--fs-meta);
      font-weight: 1100;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--winColor) 40%, transparent);
      background: color-mix(in srgb, var(--winColor) 18%, transparent);
    }
    .modalBody{ padding: 18px 16px 16px; }
    .modalTitle{
      font-size: clamp(22px, 6vw, 34px);
      font-weight: 1200;
      line-height: 1.1;
      margin: 0 0 10px;
    }
    .modalSub{
      font-size: var(--fs-body);
      color: var(--muted);
      margin: 0 0 14px;
    }
    .modalActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .shareBtn{
      min-height: 40px;
      padding: 8px 10px;
      font-size: var(--fs-meta);
      border-radius: 999px;
      box-shadow:none;
    }

    /* FOOTER */
    .footer{
      position:relative;
      z-index:1;
      margin-top: 18px;
      padding: 16px 0 4px;
      color: rgba(255,255,255,.82);
      font-size: var(--fs-meta);
      display:flex;
      justify-content:center;
    }
    .footerCard{
      width: min(980px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 12px;
    }

    /* ‚úÖ Nur fixe Breite, keine fixe H√∂he ‚Äì keine Verzerrung */
    .footerImg{
      width: 84px;
      height: auto;
      border-radius: 14px;
      object-fit: contain;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.16);
      flex: 0 0 auto;
    }

    .footerText{ min-width: 0; line-height: 1.25; }
    .footerText strong{ color: rgba(255,255,255,.98); }

    /* TOAST */
    .toast{
      position: fixed;
      left: 50%;
      bottom: max(16px, env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.70);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: var(--fs-meta);
      z-index: 1000;
      display:none;
      max-width: min(520px, calc(100vw - 24px));
      text-align:center;
    }
    .toast.show{ display:block; }

    @media (max-width: 420px){
      .sb-header{ grid-template-columns: 80px 1fr 58px 58px; }
      .sb-row{ grid-template-columns: 80px 1fr 58px 58px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="main">

    <!-- SETUP -->
    <div id="screenSetup">
      <div class="navbar">
        <div class="brand">
          <img class="logoImg" alt="Logo" src="assets/logo.png" />
          <div class="brandTitle">Dart Set &amp; Leg Counter</div>
        </div>
      </div>

      <!-- Resume -->
      <div class="card hidden" id="resumeCard">
        <div style="font-weight:1100; margin-bottom:6px;">Es gibt ein gespeichertes Match.</div>
        <div class="meta" id="resumeMeta" style="margin-top:0;">‚Äî</div>
        <div class="controls" style="margin-top:12px;">
          <button class="primary" id="resumeBtn" type="button">Fortsetzen</button>
          <button class="ghost" id="discardBtn" type="button">Match verwerfen</button>
        </div>
      </div>

      <div class="card">
        <label>Spieler (min. 2 ¬∑ max. 6)</label>
        <div class="playersList" id="playersList"></div>

        <div class="controls" style="margin-top:12px;">
          <button class="ghost" id="addPlayer" type="button">+ Spieler hinzuf√ºgen</button>
          <span class="spacer"></span>
          <span class="meta" id="playerCountHint" style="margin-top:0;">Farben sind nur einmal w√§hlbar.</span>
        </div>
        <div class="meta">Einstellungen werden gespeichert. (Match kann sp√§ter fortgesetzt werden.)</div>
      </div>

      <div class="card">
        <div class="controls" style="gap:12px;">
          <div style="flex:1; min-width: 240px;">
            <label for="firstToSets">Sets (First to)</label>
            <select id="firstToSets"></select>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label for="legsToWinSet">Legs (First to)</label>
            <select id="legsToWinSet"></select>
          </div>
        </div>
      </div>

      <!-- Anwurf im Setup -->
      <div class="card compact">
        <label for="firstServer">Anwurf in Set 1 / Leg 1</label>
        <select id="firstServer"></select>

        <div class="meta" id="formatHint"></div>

        <div class="controls" style="margin-top:14px;">
          <button class="primary" id="startBtn" type="button">Spiel starten</button>
          <button class="ghost" id="quickHelpBtn" type="button">Kurzhilfe</button>
        </div>

        <div class="meta" id="helpText" style="display:none;">
          Im Spiel: Tippen Sie auf die Spielerzeile = Leg +1. Langer Druck = R√ºckg√§ngig.<br>
          Der ‚ñ∂-Pfeil zeigt den Anwurf f√ºrs n√§chste Leg.
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="screenGame" class="hidden">
      <div class="navbar">
        <div class="brand">
          <img class="logoImg" alt="Logo" src="assets/logo.png" />
          <div class="brandTitle">Dart Set &amp; Leg Counter</div>
        </div>
      </div>

      <div class="card scoreboard">
        <div class="sb-header">
          <div class="col">ANWURF</div>
          <div class="left">NAME</div>
          <div class="col">SETS</div>
          <div class="col">LEGS</div>
        </div>

        <div id="scoreRows"></div>

        <div style="padding:12px 14px;">
          <div class="badgeLine">
            <span class="pill" id="setsPill"></span>
            <span class="pill" id="legsPill"></span>

            <!-- ‚úÖ Spieler A/B statt nur A/B -->
            <span class="pill" id="pillA"></span>
            <span class="pill" id="pillB"></span>
          </div>

          <div class="controls" style="margin-top:12px;">
            <button class="ghost" id="undo" type="button">R√ºckg√§ngig</button>
            <button class="primary" id="saveResume" type="button">Speichern &amp; sp√§ter fortsetzen</button>
            <span class="spacer"></span>
            <button class="ghost small" id="toggleLog" type="button" aria-expanded="false">Verlauf anzeigen</button>
          </div>

          <div class="controls" style="margin-top:10px;">
            <button class="ghost" id="endToSetup" type="button">Beenden &amp; zur√ºck zum Setup</button>
          </div>

          <div class="log hidden" id="log"></div>
          <div class="hint">Anwurf (‚ñ∂) rotiert automatisch pro Leg und pro Set durch die Spieler.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <footer class="footer" aria-label="Footer">
    <div class="footerCard">
      <img class="footerImg" alt="Nici" src="assets/nico.jpg" />
      <div class="footerText">
        <strong>Der Counter wird dir bereitgestellt von Nici (den aber jeder leider nur Nico nennt)</strong><br><br>
        Viel Spa√ü beim Spielen und auf das ein oder andere Spa√ügetr√§nk! üçª
      </div>
    </div>
  </footer>

</div>

<!-- WIN MODAL -->
<div class="modalOverlay" id="winModal" role="dialog" aria-modal="true" aria-label="Match beendet">
  <div class="modalCard" style="--winColor: var(--pA);">
    <div class="modalTop">
      <span class="tag" id="winTag">üèÜ Match beendet</span>
      <span style="font-weight:1100; color: rgba(255,255,255,.82); font-size: var(--fs-meta);" id="winScore">‚Äî</span>
    </div>
    <div class="modalBody">
      <h2 class="modalTitle" id="winTitle">Gl√ºckwunsch!</h2>
      <p class="modalSub" id="winSub">‚Äî</p>

      <!-- ‚úÖ Nur 2 Buttons + Share Icon -->
      <div class="modalActions">
        <button class="primary" id="winRematch" type="button">Revanche</button>
        <button class="ghost" id="winToSetup" type="button">Zum Setup</button>
        <button class="ghost shareBtn" id="winShare" type="button" title="Teilen">üì§ Teilen</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SETTINGS_KEY = "dart_counter_settings_v24";
  const MATCH_KEY    = "dart_counter_match_v24";
  const APP_URL      = "https://nicoloehle.github.io/dart-counter/";

  const MIN_PLAYERS = 2;
  const MAX_PLAYERS = 6;

  /* Farben sortiert + ohne schwarz/wei√ü/grau, mit braun/dunkelblau/violett/pink */
  const COLOR_OPTIONS = [
    { key: "red",      name: "Rot",        hex: "#d61f26" },
    { key: "green",    name: "Gr√ºn",       hex: "#14a44d" },
    { key: "yellow",   name: "Gelb",       hex: "#f2c230" },
    { key: "orange",   name: "Orange",     hex: "#f97316" },
    { key: "pink",     name: "Pink",       hex: "#ff3ea5" },
    { key: "violet",   name: "Violett",    hex: "#7c3aed" },
    { key: "blue",     name: "Blau",       hex: "#2f6bff" },
    { key: "darkblue", name: "Dunkelblau", hex: "#1e3a8a" },
    { key: "brown",    name: "Braun",      hex: "#7a4a2e" }
  ];

  const el = (id) => document.getElementById(id);
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  function haptic(ms = 14) { try { if (navigator.vibrate) navigator.vibrate(ms); } catch(_){} }

  /* Simple click sounds */
  let audioCtx = null;
  function ensureAudio(){
    if(audioCtx) return;
    try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    catch(_){ audioCtx = null; }
  }
  function beep(freq=520, ms=45, type="sine", gain=0.05){
    try{
      ensureAudio();
      if(!audioCtx) return;
      if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); setTimeout(()=>{ try{o.stop();}catch(_){} }, ms);
    }catch(_){}
  }
  const sfx = {
    tap(){ beep(520, 40, "sine", 0.045); },
    undo(){ beep(260, 60, "triangle", 0.05); },
    set(){ beep(740, 70, "square", 0.04); },
    ui(){  beep(420, 35, "sine", 0.035); },
    win(){ beep(880, 110, "triangle", 0.05); }
  };

  function toast(msg){
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1600);
  }

  const state = {
    players: [
      { id: "p1", name: "", color: COLOR_OPTIONS[0].hex },
      { id: "p2", name: "", color: COLOR_OPTIONS[1].hex }
    ],
    firstToSets: 3,
    legsToWinSet: 3,
    firstServerId: "p1",

    match: {
      inProgress:false,
      matchOver:false,
      sets:{},
      legs:{},
      legsTotal:{},
      history:[],
      setNo:1
    }
  };

  function playerName(p, fallback){ const n=(p?.name||"").trim(); return n ? n : fallback; }
  function getPlayerById(id){ return state.players.find(p => p.id === id) || null; }

  function usedColors(exceptId=null){
    const used = new Set();
    for(const p of state.players){
      if(exceptId && p.id === exceptId) continue;
      used.add((p.color||"").toLowerCase());
    }
    return used;
  }
  function firstFreeColor(usedSet){
    const found = COLOR_OPTIONS.find(c => !usedSet.has(c.hex.toLowerCase()));
    return found ? found.hex : COLOR_OPTIONS[0].hex;
  }
  function enforceUniqueColorsAll(){
    const seen = new Set();
    for(const p of state.players){
      const c = (p.color||"").toLowerCase();
      if(!c || seen.has(c)){
        const used = usedColors(p.id);
        p.color = firstFreeColor(used);
      }
      seen.add(p.color.toLowerCase());
    }
  }

  function applyFirstTwoColorsToCSS(){
    const p1 = state.players[0] || { color: COLOR_OPTIONS[0].hex };
    const p2 = state.players[1] || { color: COLOR_OPTIONS[1].hex };
    document.documentElement.style.setProperty("--pA", p1.color || COLOR_OPTIONS[0].hex);
    document.documentElement.style.setProperty("--pB", p2.color || COLOR_OPTIONS[1].hex);
    el("pillA").textContent = `Spieler 1: ${playerName(p1,"Spieler 1")}`;
    el("pillB").textContent = `Spieler 2: ${playerName(p2,"Spieler 2")}`;
  }

  function saveSettings(){
    try{
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({
        players: state.players,
        firstToSets: state.firstToSets,
        legsToWinSet: state.legsToWinSet,
        firstServerId: state.firstServerId
      }));
    }catch(_){}
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return;
      const s = JSON.parse(raw);

      if(Array.isArray(s.players) && s.players.length >= MIN_PLAYERS){
        state.players = s.players.slice(0, MAX_PLAYERS).map((p, i)=>({
          id: (typeof p.id === "string" && p.id) ? p.id : ("p"+(i+1)),
          name: (typeof p.name === "string") ? p.name : "",
          color: (typeof p.color === "string" && p.color) ? p.color : COLOR_OPTIONS[i % COLOR_OPTIONS.length].hex
        }));
        while(state.players.length < MIN_PLAYERS){
          state.players.push({ id: uid(), name: "", color: firstFreeColor(usedColors(null)) });
        }
      }

      state.firstToSets  = Number.isFinite(+s.firstToSets) ? Math.min(7, Math.max(1, +s.firstToSets)) : state.firstToSets;
      state.legsToWinSet = Number.isFinite(+s.legsToWinSet) ? Math.min(7, Math.max(1, +s.legsToWinSet)) : state.legsToWinSet;

      if(typeof s.firstServerId === "string" && s.firstServerId && getPlayerById(s.firstServerId)){
        state.firstServerId = s.firstServerId;
      }else{
        state.firstServerId = state.players[0]?.id || "p1";
      }

      enforceUniqueColorsAll();
    }catch(_){}
  }

  function fillOneToSeven(selectEl, defaultVal){
    selectEl.innerHTML = "";
    for(let i=1;i<=7;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      if(i === defaultVal) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }

  function updateFirstServerSelect(){
    const sel = el("firstServer");
    const current = state.firstServerId;
    sel.innerHTML = "";
    state.players.forEach((p, idx)=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = playerName(p, `Spieler ${idx+1}`);
      sel.appendChild(opt);
    });
    if(getPlayerById(current)){
      sel.value = current;
    }else{
      sel.value = state.players[0]?.id || "";
      state.firstServerId = sel.value || state.firstServerId;
      saveSettings();
    }
  }

  function renderSetupHint(){
    const sets = +el("firstToSets").value;
    const legs = +el("legsToWinSet").value;
    const starter = getPlayerById(el("firstServer").value);
    el("formatHint").textContent =
      `Match: First to ${sets} Sets ¬∑ Set: First to ${legs} Legs ¬∑ Anwurf Start: ${playerName(starter, "Spieler 1")}`;
  }

  function show(screen){
    el("screenSetup").classList.toggle("hidden", screen !== "setup");
    el("screenGame").classList.toggle("hidden", screen !== "game");
    openPaletteFor = null;
    renderPlayers();
    updateFirstServerSelect();
    renderResumeCard();
  }

  let openPaletteFor = null;

  function updatePlayerCountUI(){
    const n = state.players.length;
    const btn = el("addPlayer");
    const hint = el("playerCountHint");
    const canAdd = n < MAX_PLAYERS;

    btn.disabled = !canAdd;
    btn.style.opacity = canAdd ? "1" : ".55";
    hint.textContent = `Spieler: ${n}/${MAX_PLAYERS} ¬∑ Farben sind nur einmal w√§hlbar.`;
  }

  function renderPlayers(){
    const list = el("playersList");
    list.innerHTML = "";

    state.players.forEach((p, idx)=>{
      const row = document.createElement("div");
      row.className = "playerRow";

      const top = document.createElement("div");
      top.className = "playerRowTop";

      const colorBtn = document.createElement("button");
      colorBtn.type = "button";
      colorBtn.className = "colorPickBtn";
      colorBtn.style.setProperty("--dot", p.color);
      colorBtn.addEventListener("click", ()=>{
        openPaletteFor = (openPaletteFor === p.id) ? null : p.id;
        renderPlayers();
        updateFirstServerSelect();
        haptic(8); sfx.ui();
      });

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = `Spieler ${idx+1}`;
      input.value = (typeof p.name === "string") ? p.name : "";

      /* ‚úÖ Mobile: Done/Fertig + Enter schlie√üt Feld */
      input.setAttribute("enterkeyhint", "done");
      input.setAttribute("inputmode", "text");
      input.setAttribute("autocomplete", "name");
      input.setAttribute("autocapitalize", "words");
      input.setAttribute("autocorrect", "off");
      input.setAttribute("spellcheck", "false");

      input.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          input.blur();
        }
      });

      input.addEventListener("input", ()=>{
        p.name = input.value;
        saveSettings();
        updateFirstServerSelect();
        applyFirstTwoColorsToCSS();
      });
      input.addEventListener("blur", ()=>{
        p.name = input.value;
        saveSettings();
        updateFirstServerSelect();
        applyFirstTwoColorsToCSS();
      });

      let rightEl = document.createElement("div");
      if(state.players.length > MIN_PLAYERS && idx >= MIN_PLAYERS){
        const trash = document.createElement("button");
        trash.type = "button";
        trash.className = "trashBtn ghost";
        trash.textContent = "üóëÔ∏è";
        trash.addEventListener("click", ()=>{
          state.players = state.players.filter(x=>x.id !== p.id);
          openPaletteFor = null;

          if(!getPlayerById(state.firstServerId)){
            state.firstServerId = state.players[0]?.id || "p1";
          }

          enforceUniqueColorsAll();
          saveSettings();
          applyFirstTwoColorsToCSS();
          renderPlayers();
          updateFirstServerSelect();
          renderSetupHint();
          updatePlayerCountUI();
          haptic(12); sfx.ui();
        });
        rightEl = trash;
      }

      top.appendChild(colorBtn);
      top.appendChild(input);
      top.appendChild(rightEl);
      row.appendChild(top);

      if(openPaletteFor === p.id){
        const pal = document.createElement("div");
        pal.className = "palette";
        const used = usedColors(p.id);

        COLOR_OPTIONS.forEach(c=>{
          const sw = document.createElement("button");
          sw.type = "button";
          sw.className = "swatch";
          sw.style.setProperty("--c", c.hex);

          const check = document.createElement("span");
          check.className = "check";
          check.textContent = "‚úì";
          sw.appendChild(check);

          const hex = c.hex.toLowerCase();
          const isSelected = hex === (p.color||"").toLowerCase();
          const isTaken = used.has(hex) && !isSelected;

          sw.classList.toggle("selected", isSelected);
          sw.classList.toggle("taken", isTaken);

          sw.addEventListener("click", ()=>{
            if(isTaken) return;
            p.color = c.hex;
            enforceUniqueColorsAll();
            saveSettings();
            applyFirstTwoColorsToCSS();
            renderPlayers();
            updateFirstServerSelect();
            haptic(10); sfx.ui();
          });

          pal.appendChild(sw);
        });

        row.appendChild(pal);
      }

      list.appendChild(row);
    });

    updatePlayerCountUI();
  }

  document.addEventListener("pointerdown", (e)=>{
    if(!openPaletteFor) return;
    const inside = e.target.closest(".palette") || e.target.closest(".colorPickBtn") || e.target.closest(".swatch");
    if(!inside){
      openPaletteFor = null;
      renderPlayers();
    }
  }, { passive: true });

  function initScoresForPlayers(){
    state.match.sets = {};
    state.match.legs = {};
    state.match.legsTotal = {};
    state.players.forEach(p=>{
      state.match.sets[p.id] = 0;
      state.match.legs[p.id] = 0;
      state.match.legsTotal[p.id] = 0;
    });
    state.match.setNo = 1;
  }

  function snapshot(){
    state.match.history.push(JSON.parse(JSON.stringify({
      players: state.players,
      firstToSets: state.firstToSets,
      legsToWinSet: state.legsToWinSet,
      firstServerId: state.firstServerId,
      match: state.match
    })));
    if(state.match.history.length > 80) state.match.history.shift();
  }

  function logLine(t){
    const prev = el("log").textContent || "";
    const sep = prev.trim().length ? "\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n" : "";
    el("log").textContent = t + sep + prev;
  }

  function currentLegNumberWithinSet(){
    return Object.values(state.match.legs).reduce((a,b)=>a+(+b||0), 0) + 1;
  }

  function computeThrowerId(){
    const n = state.players.length;
    const startIdx = Math.max(0, state.players.findIndex(p=>p.id === state.firstServerId));
    const setStarterIdx = (startIdx + ((state.match.setNo - 1) % n)) % n;
    const legOffset = (currentLegNumberWithinSet() - 1) % n;
    return state.players[(setStarterIdx + legOffset) % n]?.id || state.players[0]?.id || null;
  }

  /* ‚úÖ Fix f√ºr Doppelz√§hlung: NUR Pointer-Events */
  function attachTapAndLongPress(targetEl, onTap, onLongPress){
    const LONG = 450;
    let timer = null;
    let longDone = false;

    const clear = () => { if(timer) clearTimeout(timer); timer = null; };
    const start = () => {
      longDone = false;
      clear();
      timer = setTimeout(() => { longDone = true; onLongPress(); }, LONG);
    };
    const end = () => {
      clear();
      if(!longDone) onTap();
    };

    targetEl.addEventListener("pointerdown", start, { passive:true });
    targetEl.addEventListener("pointerup", end);
    targetEl.addEventListener("pointercancel", clear);
    targetEl.addEventListener("pointerleave", clear);
    targetEl.addEventListener("contextmenu", (e)=> e.preventDefault());
  }

  function renderGame(){
    applyFirstTwoColorsToCSS();

    const rows = el("scoreRows");
    rows.innerHTML = "";
    const throwerId = computeThrowerId();

    state.players.forEach((p, idx)=>{
      const row = document.createElement("div");
      row.className = "sb-row playerDyn";
      row.style.setProperty("--rowColor", p.color || "#ffffff");

      const serve = document.createElement("div");
      serve.className = "serveCell";
      serve.textContent = "‚ñ∂";
      serve.classList.toggle("none", p.id !== throwerId);

      const name = document.createElement("div");
      name.className = "name";
      const span = document.createElement("span");
      span.textContent = playerName(p, `Spieler ${idx+1}`);
      name.appendChild(span);

      const sets = document.createElement("div");
      sets.className = "num";
      sets.textContent = String(state.match.sets[p.id] ?? 0);

      const legs = document.createElement("div");
      legs.className = "num";
      legs.textContent = String(state.match.legs[p.id] ?? 0);

      row.appendChild(serve);
      row.appendChild(name);
      row.appendChild(sets);
      row.appendChild(legs);

      attachTapAndLongPress(row, ()=>addLeg(p.id), undo);
      rows.appendChild(row);
    });

    el("setsPill").textContent = `Sets: First to ${state.firstToSets}`;
    el("legsPill").textContent = `Legs/Set: First to ${state.legsToWinSet}`;
  }

  function scoreSummarySets(){
    return state.players.map((p,i) => `${playerName(p,`Spieler ${i+1}`)}: ${state.match.sets[p.id]||0}`).join(" ¬∑ ");
  }
  function scoreSummaryLegsInSet(){
    return state.players.map((p,i) => `${playerName(p,`Spieler ${i+1}`)}: ${state.match.legs[p.id]||0}`).join(" ¬∑ ");
  }
  function scoreSummaryLegsTotal(){
    return state.players.map((p,i) => `${playerName(p,`Spieler ${i+1}`)}: ${state.match.legsTotal[p.id]||0}`).join(" ¬∑ ");
  }

  function finishMatch(winnerId){
    state.match.matchOver = true;
    try{ localStorage.removeItem(MATCH_KEY); }catch(_){}
    showWinModal(winnerId);
    renderGame();
  }

  /* ‚úÖ Set vergeben + Legs im Set zur√ºcksetzen */
  function awardSet(playerId){
    state.match.sets[playerId] = (state.match.sets[playerId] || 0) + 1;

    for(const p of state.players){
      state.match.legs[p.id] = 0;
    }

    logLine(`Set an ${playerName(getPlayerById(playerId), "Spieler")} ‚Äî Sets: ${scoreSummarySets()}`);
    sfx.set(); haptic(18);

    state.match.setNo += 1;

    if((state.match.sets[playerId] || 0) >= state.firstToSets){
      finishMatch(playerId);
    }
  }

  /* ‚úÖ Leg hinzuf√ºgen + wenn >= legsToWinSet => Set vergeben */
  function addLeg(playerId){
    if(state.match.matchOver) return;

    snapshot();

    state.match.legs[playerId] = (state.match.legs[playerId] || 0) + 1;
    state.match.legsTotal[playerId] = (state.match.legsTotal[playerId] || 0) + 1;

    haptic(12); sfx.tap();
    logLine(`Leg an ${playerName(getPlayerById(playerId),"Spieler")} ‚Äî Legs (Set): ${scoreSummaryLegsInSet()}`);

    if((state.match.legs[playerId] || 0) >= state.legsToWinSet){
      awardSet(playerId);
    }

    renderGame();
  }

  function undo(){
    if(state.match.matchOver) return;
    const prev = state.match.history.pop();
    if(!prev) return;

    state.players = prev.players;
    state.firstToSets = prev.firstToSets;
    state.legsToWinSet = prev.legsToWinSet;
    state.firstServerId = prev.firstServerId;
    state.match = prev.match;

    enforceUniqueColorsAll();
    applyFirstTwoColorsToCSS();
    saveSettings();

    haptic(10); sfx.undo();
    logLine("R√ºckg√§ngig.");
    renderGame();
  }

  function toggleLog(){
    el("log").classList.toggle("hidden");
    const vis = !el("log").classList.contains("hidden");
    el("toggleLog").textContent = vis ? "Verlauf ausblenden" : "Verlauf anzeigen";
    el("toggleLog").setAttribute("aria-expanded", String(vis));
    haptic(8); sfx.ui();
  }

  function endAndReturnToSetup(){
    if(confirm("Spiel beenden und zum Setup zur√ºck?")){
      show("setup");
      haptic(10); sfx.ui();
    }
  }

  function showWinModal(winnerId){
    const winner = getPlayerById(winnerId);
    const modal = el("winModal");
    const card = modal.querySelector(".modalCard");
    const winColor = winner?.color || COLOR_OPTIONS[0].hex;
    card.style.setProperty("--winColor", winColor);

    el("winTitle").textContent = `Gl√ºckwunsch ${playerName(winner,"Spieler")}!`;
    el("winScore").textContent = `Sets: ${scoreSummarySets()}`;
    el("winSub").textContent = `Legs gesamt: ${scoreSummaryLegsTotal()}`;

    modal.classList.add("show");
    haptic(40); sfx.win();
  }
  function hideWinModal(){ el("winModal").classList.remove("show"); }

  function loadSavedMatch(){
    try{
      const raw = localStorage.getItem(MATCH_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(_){ return null; }
  }

  function renderResumeCard(){
    const saved = loadSavedMatch();
    const card = el("resumeCard");
    if(!saved || !saved.match || saved.match.matchOver){
      card.classList.add("hidden");
      return;
    }
    card.classList.remove("hidden");
    const dt = new Date(saved.savedAt || Date.now());
    const names = (saved.players || []).map((p,i)=> (p.name||`Spieler ${i+1}`)).join(" ¬∑ ");
    el("resumeMeta").textContent = `${names} ‚Äî gespeichert: ${dt.toLocaleString()}`;
  }

  function resumeSavedMatch(){
    const saved = loadSavedMatch();
    if(!saved) return;

    state.players = (saved.players || state.players).slice(0, MAX_PLAYERS);
    if(state.players.length < MIN_PLAYERS){
      while(state.players.length < MIN_PLAYERS){
        state.players.push({ id: uid(), name: "", color: firstFreeColor(usedColors(null)) });
      }
    }

    state.firstToSets = saved.firstToSets || state.firstToSets;
    state.legsToWinSet = saved.legsToWinSet || state.legsToWinSet;
    state.firstServerId = saved.firstServerId || (state.players[0]?.id);

    state.match = saved.match || state.match;
    state.match.inProgress = true;
    state.match.matchOver = !!state.match.matchOver;

    enforceUniqueColorsAll();
    applyFirstTwoColorsToCSS();
    saveSettings();
    updateFirstServerSelect();

    show("game");
    renderGame();
    toast("‚ñ∂Ô∏è Match fortgesetzt");
    haptic(14); sfx.ui();
  }

  function discardSavedMatch(){
    if(confirm("Gespeichertes Match wirklich verwerfen?")){
      try{ localStorage.removeItem(MATCH_KEY); }catch(_){}
      renderResumeCard();
      toast("üóëÔ∏è Gespeichertes Match entfernt");
      haptic(10); sfx.ui();
    }
  }

  /* ‚úÖ Speichern + Button-Best√§tigung */
  function saveMatchToStorage(){
    const btn = el("saveResume");
    const oldText = btn.textContent;

    btn.disabled = true;
    btn.textContent = "Speichere ‚Ä¶";

    try{
      const payload = {
        savedAt: Date.now(),
        players: state.players,
        firstToSets: state.firstToSets,
        legsToWinSet: state.legsToWinSet,
        firstServerId: state.firstServerId,
        match: state.match
      };
      localStorage.setItem(MATCH_KEY, JSON.stringify(payload));

      btn.textContent = "Gespeichert ‚úì";
      toast("‚úÖ Match gespeichert. Sie k√∂nnen sp√§ter fortsetzen.");
      haptic(18); sfx.ui();
      renderResumeCard();

      setTimeout(()=>{
        btn.disabled = false;
        btn.textContent = oldText;
      }, 1100);

    }catch(_){
      btn.disabled = false;
      btn.textContent = oldText;
      toast("‚ùå Speichern fehlgeschlagen.");
    }
  }

  function buildShareText(){
    return [
      "üéØ Dart Set & Leg Counter",
      "",
      "üìå Ergebnis (Sets):",
      scoreSummarySets(),
      "",
      "üìå Legs gesamt:",
      scoreSummaryLegsTotal(),
      "",
      `‚öôÔ∏è Matchformat: First to ${state.firstToSets} Sets ¬∑ First to ${state.legsToWinSet} Legs`,
      "",
      `üëâ App √∂ffnen: ${APP_URL}`
    ].join("\n");
  }

  async function shareResult(){
    const text = buildShareText();
    try{
      if(navigator.share){
        await navigator.share({ title:"Dart Set & Leg Counter", text, url: APP_URL });
      }else{
        await navigator.clipboard.writeText(text);
        toast("üìã In die Zwischenablage kopiert");
      }
    }catch(_){
      try{
        await navigator.clipboard.writeText(text);
        toast("üìã In die Zwischenablage kopiert");
      }catch(__){
        alert(text);
      }
    }
  }

  function startMatch(){
    if(state.players.length < MIN_PLAYERS){
      alert("Mindestens 2 Spieler erforderlich.");
      return;
    }
    if(state.players.length > MAX_PLAYERS){
      state.players = state.players.slice(0, MAX_PLAYERS);
    }

    state.firstToSets  = +el("firstToSets").value;
    state.legsToWinSet = +el("legsToWinSet").value;
    state.firstServerId = el("firstServer").value || state.players[0].id;

    state.match.inProgress = true;
    state.match.matchOver = false;
    state.match.history = [];
    initScoresForPlayers();
    el("log").textContent = "";

    logLine(`Start ‚Äî First to ${state.firstToSets} Sets ‚Äî First to ${state.legsToWinSet} Legs`);
    saveSettings();

    haptic(12); sfx.ui();
    show("game");
    renderGame();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    document.addEventListener("pointerdown", ()=>ensureAudio(), { once:true, passive:true });

    loadSettings();
    enforceUniqueColorsAll();
    applyFirstTwoColorsToCSS();

    fillOneToSeven(el("firstToSets"), state.firstToSets);
    fillOneToSeven(el("legsToWinSet"), state.legsToWinSet);

    renderPlayers();
    updateFirstServerSelect();
    el("firstServer").value = state.firstServerId;

    renderSetupHint();
    renderResumeCard();

    el("addPlayer").addEventListener("click", ()=>{
      if(state.players.length >= MAX_PLAYERS){
        toast("Maximal 6 Spieler erlaubt.");
        return;
      }
      const used = usedColors(null);
      const newColor = firstFreeColor(used);
      state.players.push({ id: uid(), name: "", color: newColor });
      enforceUniqueColorsAll();
      saveSettings();
      renderPlayers();
      updateFirstServerSelect();
      renderSetupHint();
      applyFirstTwoColorsToCSS();
      haptic(12); sfx.ui();
    });

    ["firstToSets","legsToWinSet"].forEach(id=>{
      el(id).addEventListener("change", ()=>{
        state.firstToSets  = +el("firstToSets").value;
        state.legsToWinSet = +el("legsToWinSet").value;
        saveSettings();
        renderSetupHint();
        sfx.ui();
      });
    });

    el("firstServer").addEventListener("change", ()=>{
      state.firstServerId = el("firstServer").value;
      saveSettings();
      renderSetupHint();
      sfx.ui();
    });

    el("quickHelpBtn").addEventListener("click", ()=>{
      const t = el("helpText");
      t.style.display = (t.style.display === "none") ? "block" : "none";
      haptic(8); sfx.ui();
    });

    el("startBtn").addEventListener("click", startMatch);

    el("toggleLog").addEventListener("click", toggleLog);
    el("undo").addEventListener("click", undo);
    el("endToSetup").addEventListener("click", endAndReturnToSetup);

    el("saveResume").addEventListener("click", saveMatchToStorage);
    el("resumeBtn").addEventListener("click", resumeSavedMatch);
    el("discardBtn").addEventListener("click", discardSavedMatch);

    el("winRematch").addEventListener("click", ()=>{
      hideWinModal();
      state.match.matchOver = false;
      state.match.history = [];
      initScoresForPlayers();
      el("log").textContent = "";
      logLine(`Revanche ‚Äî First to ${state.firstToSets} Sets ‚Äî First to ${state.legsToWinSet} Legs`);
      renderGame();
      haptic(14); sfx.ui();
    });

    el("winToSetup").addEventListener("click", ()=>{
      hideWinModal();
      state.match.matchOver = false;
      show("setup");
      haptic(10); sfx.ui();
    });

    el("winShare").addEventListener("click", shareResult);

    el("winModal").addEventListener("click", (e)=>{
      if(e.target === el("winModal")){ e.preventDefault(); e.stopPropagation(); }
    });
  });
</script>
</body>
</html>